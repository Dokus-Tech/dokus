---
# ModSecurity Web Application Firewall Configuration
# Integrated with NGINX Ingress Controller

apiVersion: v1
kind: ConfigMap
metadata:
  name: modsecurity-config
  namespace: dokus-production
data:
  # Main ModSecurity configuration
  modsecurity.conf: |
    # Enable ModSecurity
    SecRuleEngine On

    # Request body access
    SecRequestBodyAccess On
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    SecRequestBodyLimitAction Reject

    # Response body access
    SecResponseBodyAccess On
    SecResponseBodyMimeType text/plain text/html text/xml application/json
    SecResponseBodyLimit 524288
    SecResponseBodyLimitAction ProcessPartial

    # File uploads
    SecTmpDir /tmp/
    SecDataDir /tmp/
    SecUploadDir /tmp/
    SecUploadKeepFiles Off

    # Debug log
    SecDebugLog /var/log/modsec_debug.log
    SecDebugLogLevel 0

    # Audit log
    SecAuditEngine RelevantOnly
    SecAuditLogRelevantStatus "^(?:5|4(?!04))"
    SecAuditLogParts ABIJDEFHZ
    SecAuditLogType Serial
    SecAuditLog /var/log/modsec_audit.log

    # Miscellaneous
    SecArgumentSeparator &
    SecCookieFormat 0
    SecUnicodeMapFile unicode.mapping 20127
    SecStatusEngine On

  # OWASP Core Rule Set (CRS) configuration
  crs-setup.conf: |
    # OWASP ModSecurity Core Rule Set ver.3.3.4
    # https://coreruleset.org/

    # Paranoia Level (1-4, higher = stricter)
    SecAction \
      "id:900000,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.paranoia_level=2"

    # Executing Paranoia Level
    SecAction \
      "id:900001,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.executing_paranoia_level=2"

    # Anomaly Scoring Thresholds
    SecAction \
      "id:900110,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.inbound_anomaly_score_threshold=5,\
       setvar:tx.outbound_anomaly_score_threshold=4"

    # HTTP violations score
    SecAction \
      "id:900120,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.http_violation_score_threshold=5"

    # SQL Injection score
    SecAction \
      "id:900130,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.sql_injection_score_threshold=5"

    # XSS score
    SecAction \
      "id:900140,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.xss_score_threshold=5"

    # Allowed HTTP methods
    SecAction \
      "id:900200,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE OPTIONS PATCH'"

    # Allowed request content types
    SecAction \
      "id:900220,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |multipart/related| |text/xml| |application/xml| |application/soap+xml| |application/json| |application/cloudevents+json| |application/cloudevents-batch+json|'"

    # Allowed HTTP versions
    SecAction \
      "id:900230,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:'tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2 HTTP/2.0'"

    # Block duration for repeated violations
    SecAction \
      "id:900300,\
       phase:1,\
       nolog,\
       pass,\
       t:none,\
       setvar:tx.block_duration=600"

  # Custom rules for Dokus application
  dokus-custom-rules.conf: |
    # Custom security rules for Dokus Backend

    # Rule ID range: 10000-19999 (custom rules)

    # Block common attack patterns
    SecRule REQUEST_URI "@rx /(\.env|\.git|\.svn|\.htaccess|wp-admin|phpmyadmin)" \
      "id:10001,\
       phase:1,\
       block,\
       log,\
       msg:'Attempted access to sensitive files',\
       severity:CRITICAL,\
       tag:'attack-disclosure'"

    # Protect against SQL injection in query parameters
    SecRule ARGS "@detectSQLi" \
      "id:10002,\
       phase:2,\
       block,\
       log,\
       msg:'SQL Injection detected in arguments',\
       severity:CRITICAL,\
       tag:'attack-sqli'"

    # Protect against XSS in query parameters
    SecRule ARGS "@detectXSS" \
      "id:10003,\
       phase:2,\
       block,\
       log,\
       msg:'XSS Attack detected in arguments',\
       severity:CRITICAL,\
       tag:'attack-xss'"

    # Rate limiting per IP (100 req/minute)
    SecAction \
      "id:10010,\
       phase:1,\
       nolog,\
       pass,\
       initcol:ip=%{REMOTE_ADDR},\
       setvar:ip.requests=+1,\
       expirevar:ip.requests=60"

    SecRule IP:REQUESTS "@gt 100" \
      "id:10011,\
       phase:1,\
       block,\
       log,\
       msg:'Rate limit exceeded: %{REMOTE_ADDR}',\
       severity:WARNING,\
       tag:'dos-protection'"

    # Protect API endpoints
    SecRule REQUEST_URI "@beginsWith /api/" \
      "id:10020,\
       phase:1,\
       nolog,\
       pass,\
       chain"
    SecRule REQUEST_HEADERS:Content-Type "!@rx ^(application/json|multipart/form-data)" \
      "block,\
       log,\
       msg:'Invalid Content-Type for API endpoint',\
       severity:WARNING"

    # Block requests with suspicious User-Agents
    SecRule REQUEST_HEADERS:User-Agent "@rx (bot|crawler|spider|scraper)" \
      "id:10030,\
       phase:1,\
       block,\
       log,\
       msg:'Blocked suspicious User-Agent: %{REQUEST_HEADERS.User-Agent}',\
       severity:WARNING,\
       tag:'bot-protection'"

    # Protect against directory traversal
    SecRule REQUEST_URI "@rx \.\./|\.\.\\" \
      "id:10040,\
       phase:1,\
       block,\
       log,\
       msg:'Directory traversal attempt detected',\
       severity:CRITICAL,\
       tag:'attack-traversal'"

    # Validate JWT tokens in Authorization header
    SecRule REQUEST_HEADERS:Authorization "!@rx ^Bearer [A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+\.[A-Za-z0-9\-_]+$" \
      "id:10050,\
       phase:1,\
       block,\
       log,\
       msg:'Invalid JWT token format',\
       severity:WARNING,\
       tag:'auth-validation',\
       chain"
    SecRule REQUEST_URI "!@beginsWith /api/auth/login"

    # Block large payloads on non-upload endpoints
    SecRule REQUEST_URI "!@rx ^/api/(attachments|uploads)" \
      "id:10060,\
       phase:1,\
       nolog,\
       pass,\
       chain"
    SecRule REQUEST_HEADERS:Content-Length "@gt 1048576" \
      "block,\
       log,\
       msg:'Request body too large for endpoint',\
       severity:WARNING"

---
# NGINX Ingress annotations for ModSecurity
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dokus-ingress-waf
  namespace: dokus-production
  annotations:
    # Enable ModSecurity
    nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    nginx.ingress.kubernetes.io/enable-owasp-core-rules: "true"
    nginx.ingress.kubernetes.io/modsecurity-snippet: |
      SecRuleEngine On
      Include /etc/nginx/modsecurity/modsecurity.conf
      Include /etc/nginx/modsecurity/crs-setup.conf
      Include /etc/nginx/modsecurity/dokus-custom-rules.conf

    # SSL/TLS Configuration
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-protocols: "TLSv1.2 TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
    nginx.ingress.kubernetes.io/hsts: "true"
    nginx.ingress.kubernetes.io/hsts-max-age: "31536000"
    nginx.ingress.kubernetes.io/hsts-include-subdomains: "true"
    nginx.ingress.kubernetes.io/hsts-preload: "true"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-rpm: "1000"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "5"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';";
      more_set_headers "Permissions-Policy: geolocation=(), microphone=(), camera=()";

    # Connection and timeout settings
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

    # DDoS Protection
    nginx.ingress.kubernetes.io/limit-req-status-code: "429"
    nginx.ingress.kubernetes.io/limit-whitelist: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - api.dokus.ai
    secretName: dokus-tls-cert
  rules:
  - host: api.dokus.ai
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dokus-database
            port:
              number: 9070
