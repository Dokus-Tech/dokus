---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: kotlin-multiplatform
pipelines:
  build-all:
    workflows:
      tests: {}
      android-build-aab:
        depends_on:
          - tests
      ios-build:
        depends_on:
          - tests
      macos-build-dmg:
        depends_on:
          - tests
  test-only:
    workflows:
      tests: {}
  android-release:
    workflows:
      tests: {}
      android-build-aab:
        depends_on:
          - tests
  ios-release:
    workflows:
      tests: {}
      ios-build:
        depends_on:
          - tests
  macos-release:
    workflows:
      tests: {}
      macos-build-dmg:
        depends_on:
          - tests
  release-all:
    workflows:
      tests: {}
      android-build-aab:
        depends_on:
          - tests
      ios-build:
        depends_on:
          - tests
      macos-build-dmg:
        depends_on:
          - tests
workflows:
  tests:
    title: Run All Tests
    summary: Runs Android unit tests and backend tests
    description: |
      Executes:
      - Android unit tests (:composeApp:testDebugUnitTest)
      - Backend tests (if test sources exist)
    steps:
      - git-clone@8:
          inputs:
            - reset_repository: "Yes"
      - set-java-version@1:
          inputs:
            - set_java_version: '21'
      - script@1:
          title: Set build number in Versions.kt
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Build number from git commit count
                BUILD_NUMBER=$(git rev-list --count HEAD)

                # Update BUILD in Versions.kt
                VERSIONS_FILE="build-logic/convention/src/main/kotlin/ai/dokus/utils/Versions.kt"
                sed -i '' "s/const val BUILD = [0-9]*/const val BUILD = $BUILD_NUMBER/" "$VERSIONS_FILE"

                # Check if this is a tag-triggered build
                if [[ "$BITRISE_GIT_TAG" =~ ^v.+ ]]; then
                  # Extract version from tag (remove 'v' prefix)
                  VERSION_NAME="${BITRISE_GIT_TAG#v}"
                  IS_RELEASE="true"
                  echo "Building RELEASE version: $VERSION_NAME (from tag $BITRISE_GIT_TAG)"
                else
                  # Extract default version name from Versions.kt
                  DEFAULT_VERSION=$(grep 'const val NAME' "$VERSIONS_FILE" | sed 's/.*"\(.*\)".*/\1/')
                  VERSION_NAME="$DEFAULT_VERSION"
                  IS_RELEASE="false"
                  echo "Building DEV version: $VERSION_NAME (BUILD=$BUILD_NUMBER)"
                fi

                # Export variables for use in subsequent steps
                envman add --key BUILD_NUMBER --value "$BUILD_NUMBER"
                envman add --key VERSION_NAME --value "$VERSION_NAME"
                envman add --key IS_RELEASE --value "$IS_RELEASE"
                envman add --key APP_VERSION_NAME --value "$VERSION_NAME"

                echo "Final Version: $VERSION_NAME (BUILD=$BUILD_NUMBER, RELEASE=$IS_RELEASE)"
                cat "$VERSIONS_FILE"
      - gradle-runner@2:
          title: Run Android Unit Tests
          inputs:
            - gradlew_path: "./gradlew"
            - gradle_task: ":composeApp:testDebugUnitTest"
            - gradle_options: "--no-daemon --stacktrace --continue"
      - script@1:
          title: Run Backend Tests (if any)
          inputs:
            - content: |
                #!/bin/bash
                set -e

                # List of backend modules to test
                BACKEND_MODULES=(
                  ":features:auth:backend"
                  ":features:cashflow:backend"
                  ":features:contacts:backend"
                  ":features:payment:backend"
                  ":features:banking:backend"
                  ":features:processor:backend"
                  ":features:ai:backend"
                )

                # Build test task list for modules that have test sources
                TEST_TASKS=""
                for module in "${BACKEND_MODULES[@]}"; do
                  MODULE_PATH="${module//:///}"
                  MODULE_PATH="${MODULE_PATH:1}"  # Remove leading /
                  TEST_DIR="$MODULE_PATH/src/test/kotlin"

                  if [ -d "$TEST_DIR" ] && [ "$(ls -A $TEST_DIR 2>/dev/null)" ]; then
                    TEST_TASKS="$TEST_TASKS ${module}:test"
                    echo "Found tests in: $module"
                  else
                    echo "No tests in: $module (skipping)"
                  fi
                done

                if [ -n "$TEST_TASKS" ]; then
                  echo "Running backend tests:$TEST_TASKS"
                  ./gradlew $TEST_TASKS --no-daemon --stacktrace --continue
                else
                  echo "No backend tests found - skipping"
                fi
      - deploy-to-bitrise-io@2: {}
  android-build-aab:
    title: Build Android AAB
    summary: Builds signed Android App Bundle for Play Store
    description: |
      Produces:
      - Signed release AAB (App Bundle)
      - Signed release APK (for direct distribution)
    steps:
      - git-clone@8:
          inputs:
            - reset_repository: "Yes"
      - set-java-version@1:
          inputs:
            - set_java_version: '21'
      - script@1:
          title: Set build number and extract version from tag
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Build number from git commit count
                BUILD_NUMBER=$(git rev-list --count HEAD)

                # Update BUILD in Versions.kt
                VERSIONS_FILE="build-logic/convention/src/main/kotlin/ai/dokus/utils/Versions.kt"
                sed -i '' "s/const val BUILD = [0-9]*/const val BUILD = $BUILD_NUMBER/" "$VERSIONS_FILE"

                # Check if this is a tag-triggered build
                if [[ "$BITRISE_GIT_TAG" =~ ^v.+ ]]; then
                  # Extract version from tag (remove 'v' prefix)
                  VERSION_NAME="${BITRISE_GIT_TAG#v}"
                  IS_RELEASE="true"
                  echo "Building RELEASE version: $VERSION_NAME (from tag $BITRISE_GIT_TAG)"
                else
                  # Extract default version name from Versions.kt
                  DEFAULT_VERSION=$(grep 'const val NAME' "$VERSIONS_FILE" | sed 's/.*"\(.*\)".*/\1/')
                  VERSION_NAME="$DEFAULT_VERSION"
                  IS_RELEASE="false"
                  echo "Building DEV version: $VERSION_NAME (BUILD=$BUILD_NUMBER)"
                fi

                # Export variables for use in subsequent steps
                envman add --key BUILD_NUMBER --value "$BUILD_NUMBER"
                envman add --key VERSION_NAME --value "$VERSION_NAME"
                envman add --key IS_RELEASE --value "$IS_RELEASE"
                envman add --key APP_VERSION_NAME --value "$VERSION_NAME"

                echo "Building Android v$VERSION_NAME (BUILD=$BUILD_NUMBER, RELEASE=$IS_RELEASE)"
                cat "$VERSIONS_FILE"
      - android-build@1:
          title: Build Release AAB
          inputs:
            - project_location: "$PROJECT_ROOT_DIR"
            - module: "$MODULE"
            - build_type: aab
            - variant: release
      - sign-apk@2:
          title: Sign AAB with Keystore
          run_if: '{{getenv "BITRISEIO_ANDROID_KEYSTORE_URL" | ne ""}}'
          inputs:
            - android_app: "$BITRISE_AAB_PATH"
            - keystore_url: "$BITRISEIO_ANDROID_KEYSTORE_URL"
            - keystore_password: "$BITRISEIO_ANDROID_KEYSTORE_PASSWORD"
            - keystore_alias: "$BITRISEIO_ANDROID_KEYSTORE_ALIAS"
            - private_key_password: "$BITRISEIO_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"
      - android-build@1:
          title: Build Release APK
          inputs:
            - project_location: "$PROJECT_ROOT_DIR"
            - module: "$MODULE"
            - build_type: apk
            - variant: release
      - sign-apk@2:
          title: Sign APK with Keystore
          run_if: '{{getenv "BITRISEIO_ANDROID_KEYSTORE_URL" | ne ""}}'
          inputs:
            - keystore_url: "$BITRISEIO_ANDROID_KEYSTORE_URL"
            - keystore_password: "$BITRISEIO_ANDROID_KEYSTORE_PASSWORD"
            - keystore_alias: "$BITRISEIO_ANDROID_KEYSTORE_ALIAS"
            - private_key_password: "$BITRISEIO_ANDROID_KEYSTORE_PRIVATE_KEY_PASSWORD"
      - script@1:
          title: Rename artifacts
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Determine artifact prefix based on build type
                if [ "$IS_RELEASE" = "true" ]; then
                  ARTIFACT_PREFIX="dokus-release"
                else
                  ARTIFACT_PREFIX="dokus-dev"
                fi
                echo "Artifact prefix: $ARTIFACT_PREFIX (IS_RELEASE=$IS_RELEASE)"

                # Rename AAB
                if [ -n "$BITRISE_SIGNED_AAB_PATH" ]; then
                  AAB_DIR=$(dirname "$BITRISE_SIGNED_AAB_PATH")
                  NEW_AAB="$AAB_DIR/${ARTIFACT_PREFIX}-${VERSION_NAME}.aab"
                  mv "$BITRISE_SIGNED_AAB_PATH" "$NEW_AAB"
                  envman add --key BITRISE_SIGNED_AAB_PATH --value "$NEW_AAB"
                  echo "Renamed AAB to: $NEW_AAB"
                fi

                # Rename APK
                if [ -n "$BITRISE_SIGNED_APK_PATH" ]; then
                  APK_DIR=$(dirname "$BITRISE_SIGNED_APK_PATH")
                  NEW_APK="$APK_DIR/${ARTIFACT_PREFIX}-${VERSION_NAME}.apk"
                  mv "$BITRISE_SIGNED_APK_PATH" "$NEW_APK"
                  envman add --key BITRISE_SIGNED_APK_PATH --value "$NEW_APK"
                  echo "Renamed APK to: $NEW_APK"
                fi
      - deploy-to-bitrise-io@2:
          inputs:
            - notify_user_groups: none
  ios-build:
    title: Build iOS IPA
    summary: Builds iOS IPA for App Store distribution
    description: |
      Produces:
      - Signed IPA (App Store distribution)
      Uses automatic code signing with App Store Connect API key
    steps:
      - git-clone@8:
          inputs:
            - reset_repository: "Yes"
      - set-java-version@1:
          inputs:
            - set_java_version: '21'
      - script@1:
          title: Set build number and extract version from tag
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Build number from git commit count
                BUILD_NUMBER=$(git rev-list --count HEAD)

                # Update BUILD in Versions.kt
                VERSIONS_FILE="build-logic/convention/src/main/kotlin/ai/dokus/utils/Versions.kt"
                sed -i '' "s/const val BUILD = [0-9]*/const val BUILD = $BUILD_NUMBER/" "$VERSIONS_FILE"

                # Check if this is a tag-triggered build
                if [[ "$BITRISE_GIT_TAG" =~ ^v.+ ]]; then
                  # Extract version from tag (remove 'v' prefix)
                  VERSION_NAME="${BITRISE_GIT_TAG#v}"
                  IS_RELEASE="true"
                  echo "Building RELEASE version: $VERSION_NAME (from tag $BITRISE_GIT_TAG)"
                else
                  # Extract default version name from Versions.kt
                  DEFAULT_VERSION=$(grep 'const val NAME' "$VERSIONS_FILE" | sed 's/.*"\(.*\)".*/\1/')
                  VERSION_NAME="$DEFAULT_VERSION"
                  IS_RELEASE="false"
                  echo "Building DEV version: $VERSION_NAME (BUILD=$BUILD_NUMBER)"
                fi

                # Export variables for use in subsequent steps
                envman add --key BUILD_NUMBER --value "$BUILD_NUMBER"
                envman add --key VERSION_NAME --value "$VERSION_NAME"
                envman add --key IS_RELEASE --value "$IS_RELEASE"
                envman add --key APP_VERSION_NAME --value "$VERSION_NAME"

                # Update iOS Info.plist
                /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION_NAME" iosApp/iosApp/Info.plist
                /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" iosApp/iosApp/Info.plist

                echo "Building iOS v$VERSION_NAME (BUILD=$BUILD_NUMBER, RELEASE=$IS_RELEASE)"
                cat "$VERSIONS_FILE"
      - gradle-runner:
          title: Build KMP Framework
          inputs:
            - gradlew_path: "./gradlew"
            - gradle_task: ":composeApp:linkReleaseFrameworkIosArm64"
            - gradle_options: "--no-daemon --stacktrace"
      - certificate-and-profile-installer:
          title: Install iOS Certificate & Profile
      - xcode-archive@5:
          title: Archive iOS App
          inputs:
            - project_path: "$BITRISE_PROJECT_PATH"
            - scheme: "$BITRISE_SCHEME"
            - distribution_method: app-store
            - configuration: Release
            - automatic_code_signing: api-key
            - xcodebuild_options: DEVELOPMENT_TEAM=V2V9U9A3MG PRODUCT_BUNDLE_IDENTIFIER=vision.invoid.dokus
      - script@1:
          title: Rename IPA artifact
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Determine artifact prefix based on build type
                if [ "$IS_RELEASE" = "true" ]; then
                  ARTIFACT_PREFIX="dokus-ios-release"
                else
                  ARTIFACT_PREFIX="dokus-ios-dev"
                fi
                echo "Artifact prefix: $ARTIFACT_PREFIX (IS_RELEASE=$IS_RELEASE)"

                if [ -n "$BITRISE_IPA_PATH" ]; then
                  IPA_DIR=$(dirname "$BITRISE_IPA_PATH")
                  NEW_IPA="$IPA_DIR/${ARTIFACT_PREFIX}-${VERSION_NAME}.ipa"
                  mv "$BITRISE_IPA_PATH" "$NEW_IPA"
                  envman add --key BITRISE_IPA_PATH --value "$NEW_IPA"
                  echo "Renamed IPA to: $NEW_IPA"
                fi
      - deploy-to-bitrise-io@2:
          inputs:
            - notify_user_groups: none
  macos-build-dmg:
    title: Build macOS DMG
    summary: Builds signed and notarized macOS DMG
    description: |
      Produces:
      - Signed DMG (Developer ID distribution)
      - Notarized for Gatekeeper

      Requires:
      - MAC_DEVELOPER_ID_APP_CERT (base64 p12)
      - MAC_DEVELOPER_ID_APP_PASSWORD
      - ASC_API_KEY_ID
      - ASC_API_KEY_ISSUER_ID
      - ASC_API_KEY_PRIVATE_KEY (base64)
    envs:
      - MAC_BUNDLE_ID: vision.invoid.dokus
    steps:
      - git-clone@8:
          inputs:
            - reset_repository: "Yes"
      - set-java-version@1:
          inputs:
            - set_java_version: '21'
      - script@1:
          title: Set build number and extract version from tag
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Build number from git commit count
                BUILD_NUMBER=$(git rev-list --count HEAD)

                # Update BUILD in Versions.kt
                VERSIONS_FILE="build-logic/convention/src/main/kotlin/ai/dokus/utils/Versions.kt"
                sed -i '' "s/const val BUILD = [0-9]*/const val BUILD = $BUILD_NUMBER/" "$VERSIONS_FILE"

                # Check if this is a tag-triggered build
                if [[ "$BITRISE_GIT_TAG" =~ ^v.+ ]]; then
                  # Extract version from tag (remove 'v' prefix)
                  VERSION_NAME="${BITRISE_GIT_TAG#v}"
                  IS_RELEASE="true"
                  echo "Building RELEASE version: $VERSION_NAME (from tag $BITRISE_GIT_TAG)"
                else
                  # Extract default version name from Versions.kt
                  DEFAULT_VERSION=$(grep 'const val NAME' "$VERSIONS_FILE" | sed 's/.*"\(.*\)".*/\1/')
                  VERSION_NAME="$DEFAULT_VERSION"
                  IS_RELEASE="false"
                  echo "Building DEV version: $VERSION_NAME (BUILD=$BUILD_NUMBER)"
                fi

                # Export variables for use in subsequent steps
                envman add --key BUILD_NUMBER --value "$BUILD_NUMBER"
                envman add --key VERSION_NAME --value "$VERSION_NAME"
                envman add --key IS_RELEASE --value "$IS_RELEASE"
                envman add --key APP_VERSION_NAME --value "$VERSION_NAME"

                echo "Building macOS v$VERSION_NAME (BUILD=$BUILD_NUMBER, RELEASE=$IS_RELEASE)"
                cat "$VERSIONS_FILE"
      - certificate-and-profile-installer@1:
          title: Install Developer ID Certificate
          run_if: '{{getenv "MAC_DEVELOPER_ID_APP_CERT" | ne ""}}'
          inputs:
            - certificate_url: "$MAC_DEVELOPER_ID_APP_CERT"
            - certificate_passphrase: "$MAC_DEVELOPER_ID_APP_PASSWORD"
      - script@1:
          title: Resolve signing identity
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Find Developer ID Application certificate
                IDENTITY=$(security find-identity -v -p codesigning | grep "Developer ID Application" | head -1 | sed 's/.*"//;s/".*//')

                if [ -z "$IDENTITY" ]; then
                  echo "Warning: No Developer ID Application certificate found"
                  echo "Building unsigned DMG"
                  envman add --key MAC_SIGNING_ENABLED --value "false"
                  envman add --key MAC_SIGNING_IDENTITY --value ""
                else
                  echo "Found signing identity: $IDENTITY"
                  envman add --key MAC_SIGNING_ENABLED --value "true"
                  envman add --key MAC_SIGNING_IDENTITY --value "$IDENTITY"
                fi
      - script@1:
          title: Configure App Store Connect API key
          run_if: '{{getenv "ASC_API_KEY_ID" | ne ""}}'
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                mkdir -p ~/.appstoreconnect/private_keys
                echo "$ASC_API_KEY_PRIVATE_KEY" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${ASC_API_KEY_ID}.p8
                chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_API_KEY_ID}.p8

                echo "Configured App Store Connect API key"
      - gradle-runner@2:
          title: Build macOS Release DMG
          inputs:
            - gradlew_path: "./gradlew"
            - gradle_task: ":composeApp:packageReleaseDmg"
            - gradle_options: "--no-daemon --stacktrace
            -Pmac.signing.enabled=$MAC_SIGNING_ENABLED
            -Pmac.signing.identity=$MAC_SIGNING_IDENTITY"
      - script@1:
          title: Notarize DMG
          run_if: '{{and (getenv "ASC_API_KEY_ID" | ne "") (eq (getenv "MAC_SIGNING_ENABLED") "true")}}'
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Find the built DMG
                DMG_PATH=$(find composeApp/build/compose/binaries/main-release/dmg -name "*.dmg" -type f | head -1)

                if [ -z "$DMG_PATH" ]; then
                  echo "Error: DMG not found"
                  exit 1
                fi

                echo "Notarizing: $DMG_PATH"

                # Submit for notarization
                xcrun notarytool submit "$DMG_PATH" \
                  --key ~/.appstoreconnect/private_keys/AuthKey_${ASC_API_KEY_ID}.p8 \
                  --key-id "$ASC_API_KEY_ID" \
                  --issuer "$ASC_API_KEY_ISSUER_ID" \
                  --wait

                # Staple the notarization ticket
                xcrun stapler staple "$DMG_PATH"

                echo "Notarization complete"
      - script@1:
          title: Rename and export DMG
          inputs:
            - content: |
                #!/bin/bash
                set -ex

                # Determine artifact prefix based on build type
                if [ "$IS_RELEASE" = "true" ]; then
                  ARTIFACT_PREFIX="dokus-macos-release"
                else
                  ARTIFACT_PREFIX="dokus-macos-dev"
                fi
                echo "Artifact prefix: $ARTIFACT_PREFIX (IS_RELEASE=$IS_RELEASE)"

                # Find DMG (check both release and main directories)
                DMG_PATH=$(find composeApp/build/compose/binaries -name "*.dmg" -type f | head -1)

                if [ -z "$DMG_PATH" ]; then
                  echo "Error: DMG not found"
                  exit 1
                fi

                DMG_DIR=$(dirname "$DMG_PATH")
                NEW_DMG="$DMG_DIR/${ARTIFACT_PREFIX}-${VERSION_NAME}.dmg"
                mv "$DMG_PATH" "$NEW_DMG"

                envman add --key BITRISE_DMG_PATH --value "$NEW_DMG"
                echo "Renamed DMG to: $NEW_DMG"
                ls -lh "$NEW_DMG"
      - deploy-to-bitrise-io@2:
          inputs:
            - deploy_path: "$BITRISE_DMG_PATH"
            - notify_user_groups: none
trigger_map:
  - push_branch: main
    pipeline: build-all
  - tag: "v*"
    pipeline: release-all
  - pull_request_source_branch: "*"
    pipeline: test-only
app:
  envs:
    - PROJECT_ROOT_DIR: "./"
      opts:
        is_expand: false
    - MODULE: composeApp
      opts:
        is_expand: false
    - VARIANT: release
      opts:
        is_expand: false
    - BITRISE_PROJECT_PATH: "./iosApp/iosApp.xcodeproj"
      opts:
        is_expand: false
    - BITRISE_SCHEME: iosApp
      opts:
        is_expand: false
    - BITRISE_DISTRIBUTION_METHOD: app-store
      opts:
        is_expand: false
meta:
  bitrise.io:
    stack: osx-xcode-edge
    machine_type_id: g2-m1.4core
