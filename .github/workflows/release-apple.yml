name: Release Apple Platforms

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run-ios:
        description: 'Publish iOS build to App Store Connect/TestFlight'
        type: boolean
        default: true
      run-macos:
        description: 'Publish macOS build to App Store Connect/TestFlight'
        type: boolean
        default: true
      include-dmg:
        description: 'Also build unsigned macOS DMG (direct download)'
        type: boolean
        default: true
  workflow_call:
    inputs:
      run-ios:
        required: false
        type: boolean
        default: true
      run-macos:
        required: false
        type: boolean
        default: true
      include-dmg:
        required: false
        type: boolean
        default: true
    secrets:
      ASC_API_KEY_ID:
        required: true
      ASC_API_KEY_ISSUER_ID:
        required: true
      ASC_API_KEY_PRIVATE_KEY:
        required: true
      IOS_DIST_CERT_P12:
        required: false
      IOS_DIST_CERT_PASSWORD:
        required: false
      IOS_PROFILE_APP_STORE:
        required: false
      MAC_DIST_CERT_P12:
        required: false
      MAC_DIST_CERT_PASSWORD:
        required: false
      MAC_PROFILE_APP_STORE:
        required: false

concurrency:
  group: release-apple-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true
  JAVA_VERSION: '21'
  APPLE_TEAM_ID: V2V9U9A3MG
  APPLE_BUNDLE_ID: vision.invoid.dokus

jobs:
  prepare:
    name: ðŸ§® Prepare versioning
    runs-on: ubuntu-latest
    outputs:
      version-major: ${{ steps.version.outputs.major }}
      version-minor: ${{ steps.version.outputs.minor }}
      build-number: ${{ steps.version.outputs.build-number }}
      version-name: ${{ steps.version.outputs.version-name }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§® Calculate versions
        id: version
        run: |
          if [ ! -f version.properties ]; then
            echo "version.properties not found" >&2
            exit 1
          fi

          MAJOR=$(grep '^major=' version.properties | cut -d'=' -f2 | tr -d '[:space:]')
          MINOR=$(grep '^minor=' version.properties | cut -d'=' -f2 | tr -d '[:space:]')
          BUILD_NUMBER=$(git rev-list --count HEAD)

          VERSION_NAME="${MAJOR}.${MINOR}.${BUILD_NUMBER}"

          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT

          echo "Version: $VERSION_NAME"

      - name: ðŸ“„ Version summary
        run: |
          echo "# Apple Release Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Major | ${{ steps.version.outputs.major }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Minor | ${{ steps.version.outputs.minor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.version.outputs.build-number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Name | ${{ steps.version.outputs.version-name }} |" >> $GITHUB_STEP_SUMMARY

  ios-release:
    name: ðŸŽ iOS TestFlight upload
    needs: prepare
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_call' && inputs.run-ios) || (github.event_name == 'workflow_dispatch' && inputs.run-ios) }}
    runs-on: macos-latest
    env:
      VERSION_NAME: ${{ needs.prepare.outputs.version-name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build-number }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœ… Validate iOS signing secrets
        env:
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_KEY_ISSUER_ID: ${{ secrets.ASC_API_KEY_ISSUER_ID }}
          ASC_API_KEY_PRIVATE_KEY: ${{ secrets.ASC_API_KEY_PRIVATE_KEY }}
          IOS_DIST_CERT_P12: ${{ secrets.IOS_DIST_CERT_P12 }}
          IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
          IOS_PROFILE_APP_STORE: ${{ secrets.IOS_PROFILE_APP_STORE }}
        run: |
          missing=0
          for var in ASC_API_KEY_ID ASC_API_KEY_ISSUER_ID ASC_API_KEY_PRIVATE_KEY IOS_DIST_CERT_P12 IOS_DIST_CERT_PASSWORD IOS_PROFILE_APP_STORE; do
            if [ -z "${!var}" ]; then
              echo "Missing secret: $var"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then
            echo "Required iOS signing secrets are missing." >&2
            exit 1
          fi

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/job-set-up

      - name: ðŸ”‘ Configure App Store Connect API key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.ASC_API_KEY_PRIVATE_KEY }}" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8

      - name: ðŸ” Import iOS distribution certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_DIST_CERT_P12 }}
          p12-password: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
        if: ${{ secrets.IOS_DIST_CERT_P12 != '' }}

      - name: ðŸ“„ Install iOS provisioning profile
        if: ${{ secrets.IOS_PROFILE_APP_STORE != '' }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROFILE_APP_STORE }}" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/Dokus_iOS.mobileprovision

      - name: ðŸ“ Update Info.plist versions
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION_NAME" iosApp/iosApp/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" iosApp/iosApp/Info.plist

      - name: ðŸ—ï¸ Build KMP frameworks for Xcode
        run: |
          ./gradlew :composeApp:embedAndSignAppleFrameworkForXcode \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME \
            -PappleBundleId=$APPLE_BUNDLE_ID \
            --no-daemon --stacktrace --build-cache

      - name: ðŸ“¦ Archive iOS app
        run: |
          xcodebuild \
            -project iosApp/iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath build/iosApp.xcarchive \
            DEVELOPMENT_TEAM=$APPLE_TEAM_ID \
            PRODUCT_BUNDLE_IDENTIFIER=$APPLE_BUNDLE_ID \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="Dokus iOS" \
            -allowProvisioningUpdates \
            archive

      - name: ðŸ“„ Create export options
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>$APPLE_TEAM_ID</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>$APPLE_BUNDLE_ID</key>
              <string>Dokus iOS</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

      - name: ðŸ“¦ Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath build/iosApp.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/export

      - name: â˜ï¸ Upload IPA to App Store Connect
        run: |
          IPA_PATH=$(find build/export -name "*.ipa" -maxdepth 2 | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "IPA not found" >&2
            exit 1
          fi
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "${{ secrets.ASC_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.ASC_API_KEY_ISSUER_ID }}"

      - name: ðŸ“¤ Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ env.VERSION_NAME }}
          path: |
            build/export/*.ipa
            build/iosApp.xcarchive
            ExportOptions.plist
          retention-days: 14

      - name: âœ… iOS release summary
        if: always()
        run: |
          IPA_PATH=$(find build/export -name "*.ipa" -maxdepth 2 | head -1)
          IPA_SIZE=$( [ -f "$IPA_PATH" ] && ls -lh "$IPA_PATH" | awk '{print $5}' || echo "n/a")
          echo "# iOS Upload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | $BUILD_NUMBER |" >> $GITHUB_STEP_SUMMARY
          echo "| IPA | ${IPA_PATH:-n/a} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size | $IPA_SIZE |" >> $GITHUB_STEP_SUMMARY

  macos-release:
    name: ðŸ’» macOS TestFlight upload
    needs: prepare
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_call' && inputs.run-macos) || (github.event_name == 'workflow_dispatch' && inputs.run-macos) }}
    runs-on: macos-latest
    env:
      VERSION_NAME: ${{ needs.prepare.outputs.version-name }}
      BUILD_NUMBER: ${{ needs.prepare.outputs.build-number }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âœ… Validate macOS signing secrets
        env:
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_KEY_ISSUER_ID: ${{ secrets.ASC_API_KEY_ISSUER_ID }}
          ASC_API_KEY_PRIVATE_KEY: ${{ secrets.ASC_API_KEY_PRIVATE_KEY }}
          MAC_DIST_CERT_P12: ${{ secrets.MAC_DIST_CERT_P12 }}
          MAC_DIST_CERT_PASSWORD: ${{ secrets.MAC_DIST_CERT_PASSWORD }}
          MAC_PROFILE_APP_STORE: ${{ secrets.MAC_PROFILE_APP_STORE }}
        run: |
          missing=0
          for var in ASC_API_KEY_ID ASC_API_KEY_ISSUER_ID ASC_API_KEY_PRIVATE_KEY MAC_DIST_CERT_P12 MAC_DIST_CERT_PASSWORD MAC_PROFILE_APP_STORE; do
            if [ -z "${!var}" ]; then
              echo "Missing secret: $var"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then
            echo "Required macOS signing secrets are missing." >&2
            exit 1
          fi

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/job-set-up

      - name: ðŸ”‘ Configure App Store Connect API key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.ASC_API_KEY_PRIVATE_KEY }}" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8

      - name: ðŸ” Import macOS distribution certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MAC_DIST_CERT_P12 }}
          p12-password: ${{ secrets.MAC_DIST_CERT_PASSWORD }}
        if: ${{ secrets.MAC_DIST_CERT_P12 != '' }}

      - name: ðŸ“„ Install macOS provisioning profile
        if: ${{ secrets.MAC_PROFILE_APP_STORE != '' }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.MAC_PROFILE_APP_STORE }}" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/Dokus_MacOS.provisionprofile

      - name: ðŸ—ï¸ Build macOS App Store pkg
        run: |
          ./gradlew :composeApp:packageReleasePkg \
            -Pcompose.desktop.mac.appStore=true \
            -PversionCode=$BUILD_NUMBER \
            -PversionName=$VERSION_NAME \
            -PappleBundleId=$APPLE_BUNDLE_ID \
            --no-daemon --stacktrace --build-cache

      - name: ðŸ” Locate pkg
        id: pkg
        run: |
          PKG_PATH=$(find composeApp/build/compose/binaries/main-release/pkg -name "*.pkg" -type f | head -1)
          if [ -z "$PKG_PATH" ]; then
            echo "pkg not found" >&2
            exit 1
          fi
          NEW_NAME="dokus-macos-${VERSION_NAME}.pkg"
          NEW_PATH="$(dirname "$PKG_PATH")/$NEW_NAME"
          mv "$PKG_PATH" "$NEW_PATH"
          echo "path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "name=$NEW_NAME" >> $GITHUB_OUTPUT
          ls -lh "$NEW_PATH"

      - name: â˜ï¸ Upload pkg to App Store Connect
        run: |
          xcrun altool --upload-app \
            --type osx \
            --file "${{ steps.pkg.outputs.path }}" \
            --apiKey "${{ secrets.ASC_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.ASC_API_KEY_ISSUER_ID }}"

      - name: ðŸ“¤ Upload pkg artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg-${{ env.VERSION_NAME }}
          path: ${{ steps.pkg.outputs.path }}
          retention-days: 14

      - name: âœ… macOS release summary
        if: always()
        run: |
          PKG_PATH="${{ steps.pkg.outputs.path }}"
          if [ -f "$PKG_PATH" ]; then
            PKG_SIZE=$(ls -lh "$PKG_PATH" | awk '{print $5}')
          else
            PKG_SIZE="n/a"
            PKG_PATH="n/a"
          fi
          echo "# macOS Upload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION_NAME |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | $BUILD_NUMBER |" >> $GITHUB_STEP_SUMMARY
          echo "| PKG | ${PKG_PATH##*/} |" >> $GITHUB_STEP_SUMMARY
          echo "| Size | $PKG_SIZE |" >> $GITHUB_STEP_SUMMARY

  dmg:
    name: ðŸ“¦ macOS DMG (direct download)
    needs: prepare
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_call' && inputs.include-dmg) || (github.event_name == 'workflow_dispatch' && inputs.include-dmg) }}
    uses: ./.github/workflows/build-macos.yml
    with:
      build-type: release
      create-release: false
