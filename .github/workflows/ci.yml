name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: write
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: '21'

jobs:
  # Quick validation checks
  validation:
    name: Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/actions/wrapper-validation@v4

  # Run tests on Bitrise (PRs and main)
  bitrise-tests:
    name: Tests (Bitrise)
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      build-url: ${{ steps.trigger.outputs.build_url }}
      build-slug: ${{ steps.trigger.outputs.build_slug }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run tests on Bitrise
        id: trigger
        env:
          BITRISE_ACCESS_TOKEN: ${{ secrets.BITRISE_ACCESS_TOKEN }}
          BITRISE_APP_SLUG: ${{ secrets.BITRISE_APP_SLUG }}
        run: |
          set -o pipefail
          chmod +x ci/gitrise.sh

          ci/gitrise.sh \
            -a "$BITRISE_ACCESS_TOKEN" \
            -s "$BITRISE_APP_SLUG" \
            -w "tests" \
            -c "${{ github.sha }}" \
            --stream 2>&1 | tee output.txt
          EXIT_CODE=$?

          BUILD_URL=$(grep -oP 'Build URL: \K[^\s]+' output.txt || echo "")
          BUILD_SLUG=$(echo "$BUILD_URL" | grep -oP 'builds/\K[a-z0-9]+' || echo "")
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_slug=$BUILD_SLUG" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

  # Build Android on Bitrise (main branch only)
  bitrise-android:
    name: Android Build (Bitrise)
    needs: [validation, bitrise-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      build-url: ${{ steps.trigger.outputs.build_url }}
      build-slug: ${{ steps.trigger.outputs.build_slug }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build Android on Bitrise
        id: trigger
        env:
          BITRISE_ACCESS_TOKEN: ${{ secrets.BITRISE_ACCESS_TOKEN }}
          BITRISE_APP_SLUG: ${{ secrets.BITRISE_APP_SLUG }}
        run: |
          set -o pipefail
          chmod +x ci/gitrise.sh

          ci/gitrise.sh \
            -a "$BITRISE_ACCESS_TOKEN" \
            -s "$BITRISE_APP_SLUG" \
            -w "android-build-aab" \
            -c "${{ github.sha }}" \
            --stream 2>&1 | tee output.txt
          EXIT_CODE=$?

          BUILD_URL=$(grep -oP 'Build URL: \K[^\s]+' output.txt || echo "")
          BUILD_SLUG=$(echo "$BUILD_URL" | grep -oP 'builds/\K[a-z0-9]+' || echo "")
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_slug=$BUILD_SLUG" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Download Android artifacts
        if: success()
        env:
          BITRISE_ACCESS_TOKEN: ${{ secrets.BITRISE_ACCESS_TOKEN }}
          BITRISE_APP_SLUG: ${{ secrets.BITRISE_APP_SLUG }}
        run: |
          BUILD_SLUG="${{ steps.trigger.outputs.build_slug }}"
          mkdir -p artifacts

          ARTIFACTS=$(curl -s "https://api.bitrise.io/v0.1/apps/${BITRISE_APP_SLUG}/builds/${BUILD_SLUG}/artifacts" \
            -H "Authorization: ${BITRISE_ACCESS_TOKEN}")

          ARTIFACT_COUNT=$(echo "$ARTIFACTS" | jq -r '.data | length')
          echo "Found $ARTIFACT_COUNT artifacts"

          for i in $(seq 0 $((ARTIFACT_COUNT - 1))); do
            SLUG=$(echo "$ARTIFACTS" | jq -r ".data[$i].slug")
            TITLE=$(echo "$ARTIFACTS" | jq -r ".data[$i].title")

            # Only download APK files
            if [[ "$TITLE" == *.apk ]]; then
              echo "Downloading: $TITLE"
              DETAIL=$(curl -s "https://api.bitrise.io/v0.1/apps/${BITRISE_APP_SLUG}/builds/${BUILD_SLUG}/artifacts/${SLUG}" \
                -H "Authorization: ${BITRISE_ACCESS_TOKEN}")
              URL=$(echo "$DETAIL" | jq -r '.data.expiring_download_url')
              if [ -n "$URL" ] && [ "$URL" != "null" ]; then
                curl -L -o "artifacts/$TITLE" "$URL"
                echo "Downloaded: $TITLE"
              fi
            fi
          done

          ls -la artifacts/

      - name: Upload Android artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/*.apk
          retention-days: 30

  # Build macOS on Bitrise (main branch only)
  bitrise-macos:
    name: macOS Build (Bitrise)
    needs: [validation, bitrise-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      build-url: ${{ steps.trigger.outputs.build_url }}
      build-slug: ${{ steps.trigger.outputs.build_slug }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build macOS on Bitrise
        id: trigger
        env:
          BITRISE_ACCESS_TOKEN: ${{ secrets.BITRISE_ACCESS_TOKEN }}
          BITRISE_APP_SLUG: ${{ secrets.BITRISE_APP_SLUG }}
        run: |
          set -o pipefail
          chmod +x ci/gitrise.sh

          ci/gitrise.sh \
            -a "$BITRISE_ACCESS_TOKEN" \
            -s "$BITRISE_APP_SLUG" \
            -w "macos-build-dmg" \
            -c "${{ github.sha }}" \
            --stream 2>&1 | tee output.txt
          EXIT_CODE=$?

          BUILD_URL=$(grep -oP 'Build URL: \K[^\s]+' output.txt || echo "")
          BUILD_SLUG=$(echo "$BUILD_URL" | grep -oP 'builds/\K[a-z0-9]+' || echo "")
          echo "build_url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "build_slug=$BUILD_SLUG" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Download macOS artifacts
        if: success()
        env:
          BITRISE_ACCESS_TOKEN: ${{ secrets.BITRISE_ACCESS_TOKEN }}
          BITRISE_APP_SLUG: ${{ secrets.BITRISE_APP_SLUG }}
        run: |
          BUILD_SLUG="${{ steps.trigger.outputs.build_slug }}"
          mkdir -p artifacts

          ARTIFACTS=$(curl -s "https://api.bitrise.io/v0.1/apps/${BITRISE_APP_SLUG}/builds/${BUILD_SLUG}/artifacts" \
            -H "Authorization: ${BITRISE_ACCESS_TOKEN}")

          ARTIFACT_COUNT=$(echo "$ARTIFACTS" | jq -r '.data | length')
          echo "Found $ARTIFACT_COUNT artifacts"

          for i in $(seq 0 $((ARTIFACT_COUNT - 1))); do
            SLUG=$(echo "$ARTIFACTS" | jq -r ".data[$i].slug")
            TITLE=$(echo "$ARTIFACTS" | jq -r ".data[$i].title")

            # Only download DMG files
            if [[ "$TITLE" == *.dmg ]]; then
              echo "Downloading: $TITLE"
              DETAIL=$(curl -s "https://api.bitrise.io/v0.1/apps/${BITRISE_APP_SLUG}/builds/${BUILD_SLUG}/artifacts/${SLUG}" \
                -H "Authorization: ${BITRISE_ACCESS_TOKEN}")
              URL=$(echo "$DETAIL" | jq -r '.data.expiring_download_url')
              if [ -n "$URL" ] && [ "$URL" != "null" ]; then
                curl -L -o "artifacts/$TITLE" "$URL"
                echo "Downloaded: $TITLE"
              fi
            fi
          done

          ls -la artifacts/

      - name: Upload macOS artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: artifacts/*.dmg
          retention-days: 30

  # Summary job - runs after all builds complete
  summary:
    name: Build Summary
    needs: [bitrise-tests, bitrise-android, bitrise-macos]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        if: needs.bitrise-android.result == 'success' || needs.bitrise-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Bitrise Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status | Build Link |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|------------|" >> $GITHUB_STEP_SUMMARY

          # Tests
          if [ "${{ needs.bitrise-tests.result }}" == "success" ]; then
            echo "| Tests | ✅ Passed | [${{ needs.bitrise-tests.outputs.build-slug }}](${{ needs.bitrise-tests.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.bitrise-tests.result }}" == "skipped" ]; then
            echo "| Tests | ⏭️ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Tests | ❌ Failed | [${{ needs.bitrise-tests.outputs.build-slug }}](${{ needs.bitrise-tests.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Android
          if [ "${{ needs.bitrise-android.result }}" == "success" ]; then
            echo "| Android | ✅ Passed | [${{ needs.bitrise-android.outputs.build-slug }}](${{ needs.bitrise-android.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.bitrise-android.result }}" == "skipped" ]; then
            echo "| Android | ⏭️ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Android | ❌ Failed | [${{ needs.bitrise-android.outputs.build-slug }}](${{ needs.bitrise-android.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi

          # macOS
          if [ "${{ needs.bitrise-macos.result }}" == "success" ]; then
            echo "| macOS | ✅ Passed | [${{ needs.bitrise-macos.outputs.build-slug }}](${{ needs.bitrise-macos.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.bitrise-macos.result }}" == "skipped" ]; then
            echo "| macOS | ⏭️ Skipped | - |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| macOS | ❌ Failed | [${{ needs.bitrise-macos.outputs.build-slug }}](${{ needs.bitrise-macos.outputs.build-url }}) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # List downloaded artifacts
          if [ -d "artifacts" ]; then
            echo "## Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            for f in artifacts/*; do
              if [ -f "$f" ]; then
                SIZE=$(du -h "$f" | cut -f1)
                NAME=$(basename "$f")
                echo "| $NAME | $SIZE |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

      - name: PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testsResult = '${{ needs.bitrise-tests.result }}';
            const testsUrl = '${{ needs.bitrise-tests.outputs.build-url }}';

            const statusEmoji = testsResult === 'success' ? '✅' : '❌';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${statusEmoji} Bitrise Tests ${testsResult === 'success' ? 'Passed' : 'Failed'}

            [View Build on Bitrise](${testsUrl})

            | Commit | Branch |
            |--------|--------|
            | \`${{ github.sha }}\` | \`${{ github.head_ref }}\` |`
            });
