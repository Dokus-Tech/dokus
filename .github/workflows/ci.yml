name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: write
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: '21'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  # Quick validation checks
  validation:
    name: ðŸ” Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/actions/wrapper-validation@v4

  # Run tests on GitHub Actions
  tests:
    name: ðŸ§ª Tests
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/job-set-up

      - name: ðŸ§ª Run Desktop/JVM tests
        run: |
          echo "Running Desktop/JVM tests..."
          ./gradlew :composeApp:desktopTest --stacktrace

      - name: ðŸ“¤ Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/test-results/**/TEST-*.xml
            **/build/reports/tests/**
          retention-days: 7

  # Build verification (ensures code compiles)
  build-check:
    name: ðŸ—ï¸ Build Check
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup environment
        uses: ./.github/actions/job-set-up

      - name: ðŸ—ï¸ Build common code
        run: |
          echo "Building common code..."
          ./gradlew :composeApp:compileKotlinDesktop --stacktrace

  # Create deployment package for releases
  create-deployment-package:
    name: ðŸ“¦ Create Deployment Package
    needs: [tests, build-check]
    if: |
      always() &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.build-check.result == 'success' || needs.build-check.result == 'skipped') &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Create deployment package
        run: |
          # Create deployment archive
          cd deployment
          zip -r ../dokus-quick-deploy.zip . -x "*.git*" -x ".env" -x ".env.backup"
          cd ..

          # Show contents
          echo "ðŸ“¦ Package contents:"
          unzip -l dokus-quick-deploy.zip

          # Get file size
          SIZE=$(du -h dokus-quick-deploy.zip | cut -f1)
          echo "ðŸ“Š Package size: $SIZE"

      - name: ðŸ“¤ Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dokus-quick-deploy.zip
          retention-days: 90

  # Summary job - runs after all checks complete
  summary:
    name: ðŸ“Š Build Summary
    needs: [validation, tests, build-check, create-deployment-package]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Validation
          if [ "${{ needs.validation.result }}" == "success" ]; then
            echo "| ðŸ” Validation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validation.result }}" == "skipped" ]; then
            echo "| ðŸ” Validation | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ” Validation | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests
          if [ "${{ needs.tests.result }}" == "success" ]; then
            echo "| ðŸ§ª Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.tests.result }}" == "skipped" ]; then
            echo "| ðŸ§ª Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ§ª Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Check
          if [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "| ðŸ—ï¸ Build Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-check.result }}" == "skipped" ]; then
            echo "| ðŸ—ï¸ Build Check | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Build Check | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Deployment Package
          if [ "${{ needs.create-deployment-package.result }}" == "success" ]; then
            echo "| ðŸ“¦ Deployment Package | âœ… Created |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-deployment-package.result }}" == "skipped" ]; then
            echo "| ðŸ“¦ Deployment Package | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“¦ Deployment Package | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "## âœ… All Checks Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ’¬ PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testsResult = '${{ needs.tests.result }}';
            const buildResult = '${{ needs.build-check.result }}';
            const allPassed = testsResult === 'success' && buildResult === 'success';
            const statusEmoji = allPassed ? 'âœ…' : 'âŒ';

            const body = `## ${statusEmoji} CI Pipeline ${allPassed ? 'Passed' : 'Failed'}

            | Check | Status |
            |-------|--------|
            | ðŸ§ª Tests | ${testsResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | ðŸ—ï¸ Build | ${buildResult === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |

            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.head_ref }}\``;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('CI Pipeline')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: âŒ Fail if checks failed
        if: needs.tests.result == 'failure' || needs.build-check.result == 'failure'
        run: exit 1

  # Create release with deployment package on main branch
  release:
    name: ðŸš€ Create Release
    needs: [tests, build-check, create-deployment-package]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.tests.result == 'success' &&
      needs.build-check.result == 'success' &&
      needs.create-deployment-package.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Generate version
        id: version
        run: |
          # Generate version from commit count and short SHA
          VERSION_CODE=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION_TAG="v0.0.${VERSION_CODE}"

          echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Version: $VERSION_TAG (build $VERSION_CODE)"

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -n 10)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi

          # Save to file for multiline
          echo "$COMMITS" > changelog.txt

          echo "ðŸ“‹ Generated changelog"

      - name: ðŸ“¥ Download Deployment Package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./artifacts

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version-tag }}
          name: Release ${{ steps.version.outputs.version-tag }}
          body: |
            # ðŸš€ Dokus Release ${{ steps.version.outputs.version-tag }}

            **Build:** ${{ steps.version.outputs.version-code }}
            **Commit:** ${{ steps.version.outputs.short-sha }}
            **Branch:** ${{ github.ref_name }}

            ## ðŸ“ Changes

            See changelog below.

            ## ðŸš€ Quick Start

            ### Deploy Backend Server

            **Linux / macOS:**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version-tag }}/dokus-quick-deploy.zip -o dokus.zip
            unzip dokus.zip -d dokus && cd dokus
            chmod +x dokus.sh && ./dokus.sh
            ```

            **Windows:**
            1. Download `dokus-quick-deploy.zip` from assets
            2. Extract and run `dokus.bat`

            **What's included:**
            - âœ… All 6 backend services (auth, cashflow, payment, contacts, banking, gateway)
            - âœ… Interactive setup with auto-generated passwords
            - âœ… Multi-architecture support (AMD64 + ARM64)
            - âœ… PostgreSQL, Redis, RabbitMQ

            ## ðŸ” Verification

            This release was automatically built and signed by GitHub Actions.

            - Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Commit: [${{ steps.version.outputs.short-sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          files: |
            ./artifacts/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: ðŸŽ‰ Release created
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version-tag }} created successfully!"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version-tag }}"

      - name: ðŸ“Š Release summary
        run: |
          echo "# ðŸ“¦ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Quick Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -L https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version-tag }}/dokus-quick-deploy.zip -o dokus.zip" >> $GITHUB_STEP_SUMMARY
          echo "unzip dokus.zip -d dokus && cd dokus" >> $GITHUB_STEP_SUMMARY
          echo "chmod +x dokus.sh && ./dokus.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat changelog.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
