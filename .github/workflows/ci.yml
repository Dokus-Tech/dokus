name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: write
  checks: write
  pull-requests: write
  actions: read

env:
  JAVA_VERSION: '21'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  # Quick validation checks
  validation:
    name: üîç Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: gradle/actions/wrapper-validation@v4

  # Run tests on GitHub Actions
  tests:
    name: üß™ Tests
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup environment
        uses: ./.github/actions/job-set-up

      - name: üß™ Run Desktop/JVM tests
        run: |
          echo "Running Desktop/JVM tests..."
          ./gradlew :composeApp:desktopTest --stacktrace

      - name: üì§ Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/test-results/**/TEST-*.xml
            **/build/reports/tests/**
          retention-days: 7

  # Build verification (ensures code compiles)
  build-check:
    name: üèóÔ∏è Build Check
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup environment
        uses: ./.github/actions/job-set-up

      - name: üèóÔ∏è Build common code
        run: |
          echo "Building common code..."
          ./gradlew :composeApp:compileKotlinDesktop --stacktrace

  # Create deployment package for releases
  create-deployment-package:
    name: üì¶ Create Deployment Package
    needs: [tests, build-check]
    if: |
      always() &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.build-check.result == 'success' || needs.build-check.result == 'skipped') &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Create deployment package
        run: |
          # Create deployment archive
          cd deployment
          zip -r ../dokus-quick-deploy.zip . -x "*.git*" -x ".env" -x ".env.backup"
          cd ..

          # Show contents
          echo "üì¶ Package contents:"
          unzip -l dokus-quick-deploy.zip

          # Get file size
          SIZE=$(du -h dokus-quick-deploy.zip | cut -f1)
          echo "üìä Package size: $SIZE"

      - name: üì§ Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dokus-quick-deploy.zip
          retention-days: 90

  # Summary job - runs after all checks complete
  summary:
    name: üìä Build Summary
    needs: [validation, tests, build-check, create-deployment-package]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: üìä Generate summary
        run: |
          echo "# üöÄ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Validation
          if [ "${{ needs.validation.result }}" == "success" ]; then
            echo "| üîç Validation | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.validation.result }}" == "skipped" ]; then
            echo "| üîç Validation | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üîç Validation | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests
          if [ "${{ needs.tests.result }}" == "success" ]; then
            echo "| üß™ Tests | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.tests.result }}" == "skipped" ]; then
            echo "| üß™ Tests | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üß™ Tests | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Build Check
          if [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "| üèóÔ∏è Build Check | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build-check.result }}" == "skipped" ]; then
            echo "| üèóÔ∏è Build Check | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üèóÔ∏è Build Check | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Deployment Package
          if [ "${{ needs.create-deployment-package.result }}" == "success" ]; then
            echo "| üì¶ Deployment Package | ‚úÖ Created |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-deployment-package.result }}" == "skipped" ]; then
            echo "| üì¶ Deployment Package | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| üì¶ Deployment Package | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.tests.result }}" == "success" ] && [ "${{ needs.build-check.result }}" == "success" ]; then
            echo "## ‚úÖ All Checks Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some Checks Failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üí¨ PR Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testsResult = '${{ needs.tests.result }}';
            const buildResult = '${{ needs.build-check.result }}';
            const allPassed = testsResult === 'success' && buildResult === 'success';
            const statusEmoji = allPassed ? '‚úÖ' : '‚ùå';

            const body = `## ${statusEmoji} CI Pipeline ${allPassed ? 'Passed' : 'Failed'}

            | Check | Status |
            |-------|--------|
            | üß™ Tests | ${testsResult === 'success' ? '‚úÖ Passed' : '‚ùå Failed'} |
            | üèóÔ∏è Build | ${buildResult === 'success' ? '‚úÖ Passed' : '‚ùå Failed'} |

            **Commit:** \`${{ github.sha }}\`
            **Branch:** \`${{ github.head_ref }}\``;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('CI Pipeline')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: ‚ùå Fail if checks failed
        if: needs.tests.result == 'failure' || needs.build-check.result == 'failure'
        run: exit 1
