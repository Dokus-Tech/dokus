name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow and ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: write
  checks: write
  pull-requests: write
  actions: read

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true
  JAVA_VERSION: '21'

jobs:
  # Quick validation checks that fail fast
  validation:
    name: ğŸ” Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: ğŸ“Š Check for TODO/FIXME
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "^\+.*\b(TODO|FIXME)\b" | grep -v "github/workflows"; then
            echo "âš ï¸ Warning: New TODOs or FIXMEs found in this PR"
          fi
        continue-on-error: true

  # Determine which platforms need testing
  changes:
    name: ğŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.filter.outputs.android }}
      ios: ${{ steps.filter.outputs.ios }}
      desktop: ${{ steps.filter.outputs.desktop }}
      wasm: ${{ steps.filter.outputs.wasm }}
      common: ${{ steps.filter.outputs.common }}
      has-changes: ${{ steps.filter.outputs.changes }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            android:
              - 'composeApp/src/androidMain/**'
              - 'features/**/androidMain/**'
              - 'foundation/**/androidMain/**'
            ios:
              - 'composeApp/src/iosMain/**'
              - 'features/**/iosMain/**'
              - 'foundation/**/iosMain/**'
            desktop:
              - 'composeApp/src/desktopMain/**'
              - 'composeApp/src/jvmMain/**'
              - 'features/**/jvmMain/**'
              - 'foundation/**/jvmMain/**'
            wasm:
              - 'composeApp/src/wasmJsMain/**'
              - 'features/**/wasmJsMain/**'
              - 'foundation/**/wasmJsMain/**'
            common:
              - 'composeApp/src/commonMain/**'
              - 'features/**/commonMain/**'
              - 'foundation/**/commonMain/**'
              - '*.gradle.kts'
              - 'gradle/**'

  # Code quality checks
  lint:
    name: ğŸ§¹ Code Quality
    needs: validation
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup environment
        uses: ./.github/actions/job-set-up

      - name: ğŸ§¹ Run ktlint
        run: |
          echo "Running Kotlin linter..."
          ./gradlew ktlintCheck --continue || echo "âš ï¸ Linting issues found"
        continue-on-error: true

      - name: ğŸ“Š Generate dependency graph
        run: ./gradlew dependencies > dependencies.txt || true

      - name: ğŸ“¤ Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-report
          path: dependencies.txt
          retention-days: 7

  # Run tests for affected platforms
  test:
    name: ğŸ§ª Tests
    needs: [validation, changes]
    if: |
      github.event_name == 'push' ||
      needs.changes.outputs.android == 'true' ||
      needs.changes.outputs.ios == 'true' ||
      needs.changes.outputs.desktop == 'true' ||
      needs.changes.outputs.common == 'true'
    uses: ./.github/workflows/test.yml
    with:
      # Common changes affect ALL platforms
      run-android: ${{ github.event_name == 'push' || needs.changes.outputs.common == 'true' || needs.changes.outputs.android == 'true' }}
      run-desktop: ${{ github.event_name == 'push' || needs.changes.outputs.common == 'true' || needs.changes.outputs.desktop == 'true' }}
      run-ios: ${{ needs.changes.outputs.common == 'true' || needs.changes.outputs.ios == 'true' }}  # Enable iOS tests when common changes

  # Build Android APK
  build-android:
    name: ğŸ—ï¸ Build Android
    needs: [test, changes]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (github.event_name == 'push' || needs.changes.outputs.common == 'true' || needs.changes.outputs.android == 'true')
    uses: ./.github/workflows/build-android.yml
    with:
      build-type: ${{ github.ref == 'refs/heads/main' && 'release' || 'debug' }}
      create-release: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    secrets: inherit

  # Summary and status reporting
  ci-status:
    name: ğŸ“Š CI Status
    runs-on: ubuntu-latest
    needs: [validation, changes, lint, test, build-android]
    if: always()

    steps:
      - name: ğŸ“Š Generate status report
        run: |
          echo "# ğŸ“Š CI Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.lint.result == 'success' && 'âœ… Passed' || needs.lint.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || needs.test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Android | ${{ needs.build-android.result == 'success' && 'âœ… Passed' || needs.build-android.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Platform changes detected
          echo "## ğŸ” Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Android: ${{ needs.changes.outputs.android == 'true' && 'âœ… Yes' || 'â– No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS: ${{ needs.changes.outputs.ios == 'true' && 'âœ… Yes' || 'â– No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Desktop: ${{ needs.changes.outputs.desktop == 'true' && 'âœ… Yes' || 'â– No' }}" >> $GITHUB_STEP_SUMMARY
          echo "- WASM: ${{ needs.changes.outputs.wasm == 'true' && 'âœ… Yes' || 'â– No' }}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Check overall status
        run: |
          if [ "${{ needs.validation.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.build-android.result }}" == "failure" ]; then
            echo "âŒ CI Pipeline Failed"
            exit 1
          fi
          echo "âœ… CI Pipeline Passed"

  # Automatic release on main branch
  release:
    name: ğŸš€ Create Release
    needs: [build-android]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.build-android.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Generate version tag
        id: version
        run: |
          # Generate version from commit count and short SHA
          VERSION_CODE=$(git rev-list --count HEAD)
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION_TAG="v1.0.${VERSION_CODE}"

          echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Version: $VERSION_TAG (build $VERSION_CODE)"

      - name: ğŸ“ Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -n 10)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi

          # Save to file for multiline
          echo "$COMMITS" > changelog.txt

          echo "ğŸ“‹ Generated changelog"

      - name: ğŸ“¥ Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./artifacts

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version-tag }}
          name: Release ${{ steps.version.outputs.version-tag }}
          body: |
            # ğŸš€ Dokus Release ${{ steps.version.outputs.version-tag }}

            **Build:** ${{ steps.version.outputs.version-code }}
            **Commit:** ${{ steps.version.outputs.short-sha }}
            **Branch:** ${{ github.ref_name }}
            **Date:** ${{ github.event.head_commit.timestamp }}

            ## ğŸ“ Changes

            ${{ steps.changelog.outputs.commits }}

            ## ğŸ“¦ Downloads

            - **Android APK**: See assets below
            - **Release Bundle (AAB)**: Available in [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ## ğŸ“± Installation

            1. Download the APK from assets
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK

            ## ğŸ” Verification

            This release was automatically built and signed by GitHub Actions.

            - Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Commit: [${{ steps.version.outputs.short-sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          files: ./artifacts/*.apk
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: ğŸ‰ Release created
        run: |
          echo "âœ… Release ${{ steps.version.outputs.version-tag }} created successfully!"
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version-tag }}"
