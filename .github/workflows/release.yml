name: Release Pipeline

on:
  push:
    tags:
      - 'v*'  # Matches v1.0.0, v2.1.3, v0.0.1-beta.1, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel releases in progress

permissions:
  contents: write    # Required for creating releases
  actions: read

jobs:
  # Validate and extract version from tag
  prepare:
    name: ðŸ·ï¸ Prepare Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version-tag: ${{ steps.version.outputs.version-tag }}
      version-name: ${{ steps.version.outputs.version-name }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Extract and validate version
        id: version
        run: |
          # Determine the tag to use
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION_TAG="${{ github.event.inputs.tag }}"
          else
            VERSION_TAG="${GITHUB_REF#refs/tags/}"
          fi

          echo "Processing version tag: $VERSION_TAG"

          # Validate semantic version format (v1.2.3 or v1.2.3-beta.1)
          if [[ ! "$VERSION_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "::error::Invalid version tag: $VERSION_TAG"
            echo "Expected format: v1.2.3 or v1.2.3-beta.1"
            exit 1
          fi

          # Extract clean version name (without 'v' prefix) for app builds
          # e.g., "v1.2.3" -> "1.2.3", "v1.2.3-beta.1" -> "1.2.3-beta.1"
          VERSION_NAME="${VERSION_TAG#v}"

          # Check if this is a pre-release (contains -alpha, -beta, -rc, etc.)
          if [[ "$VERSION_TAG" =~ -[a-zA-Z] ]]; then
            IS_PRERELEASE="true"
            echo "Detected pre-release tag"
          else
            IS_PRERELEASE="false"
            echo "Detected stable release tag"
          fi

          echo "version-tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "is-prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "Version tag: $VERSION_TAG"
          echo "Version name: $VERSION_NAME (for app builds)"
          echo "Pre-release: $IS_PRERELEASE"

  # Build and create release
  release:
    name: ðŸš€ Create Release
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Set version name for frontend app builds (from tag without 'v' prefix)
      # This is picked up by the Gradle versioning plugin
      APP_VERSION_NAME: ${{ needs.prepare.outputs.version-name }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Create deployment package
        run: |
          # Create deployment archive
          cd deployment
          zip -r ../dokus-quick-deploy.zip . -x "*.git*" -x ".env" -x ".env.backup"
          cd ..

          # Show contents
          echo "ðŸ“¦ Package contents:"
          unzip -l dokus-quick-deploy.zip

          # Get file size
          SIZE=$(du -h dokus-quick-deploy.zip | cut -f1)
          echo "ðŸ“Š Package size: $SIZE"

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" -n 10)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)")
          fi

          # Save to file for multiline
          echo "$COMMITS" > changelog.txt

          echo "Generated changelog"

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version-tag }}
          name: Release ${{ needs.prepare.outputs.version-tag }}
          body: |
            # Dokus Release ${{ needs.prepare.outputs.version-tag }}

            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}

            ## Quick Start

            ### Deploy Backend Server

            **Linux / macOS:**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.version-tag }}/dokus-quick-deploy.zip -o dokus.zip
            unzip dokus.zip -d dokus && cd dokus
            chmod +x dokus.sh && ./dokus.sh
            ```

            **Windows:**
            1. Download `dokus-quick-deploy.zip` from assets
            2. Extract and run `dokus.bat`

            **What's included:**
            - All 6 backend services (auth, cashflow, payment, contacts, banking, gateway)
            - Interactive setup with auto-generated passwords
            - Multi-architecture support (AMD64 + ARM64)
            - PostgreSQL, Redis, RabbitMQ

            ## Verification

            This release was automatically built and signed by GitHub Actions.

            - Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Commit: [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          files: |
            dokus-quick-deploy.zip
          draft: false
          prerelease: ${{ needs.prepare.outputs.is-prerelease == 'true' }}
          generate_release_notes: true

      - name: ðŸŽ‰ Release created
        run: |
          echo "Release ${{ needs.prepare.outputs.version-tag }} created successfully!"
          echo "https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.version-tag }}"

      - name: ðŸ“Š Release summary
        run: |
          echo "# Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.prepare.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "curl -L https://github.com/${{ github.repository }}/releases/download/${{ needs.prepare.outputs.version-tag }}/dokus-quick-deploy.zip -o dokus.zip" >> $GITHUB_STEP_SUMMARY
          echo "unzip dokus.zip -d dokus && cd dokus" >> $GITHUB_STEP_SUMMARY
          echo "chmod +x dokus.sh && ./dokus.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat changelog.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
