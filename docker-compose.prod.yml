# Production Docker Compose configuration
# Each service has its own PostgreSQL database

services:
  # PostgreSQL Database for Auth Service
  postgres-auth-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-auth-prod
    environment:
      POSTGRES_DB: dokus_auth
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5441:5432"
    volumes:
      - postgres-auth-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_auth"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Invoicing Service
  postgres-invoicing-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-invoicing-prod
    environment:
      POSTGRES_DB: dokus_invoicing
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5442:5432"
    volumes:
      - postgres-invoicing-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_invoicing"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Expense Service
  postgres-expense-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-expense-prod
    environment:
      POSTGRES_DB: dokus_expense
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5443:5432"
    volumes:
      - postgres-expense-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_expense"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Payment Service
  postgres-payment-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-payment-prod
    environment:
      POSTGRES_DB: dokus_payment
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5444:5432"
    volumes:
      - postgres-payment-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_payment"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Reporting Service
  postgres-reporting-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-reporting-prod
    environment:
      POSTGRES_DB: dokus_reporting
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5445:5432"
    volumes:
      - postgres-reporting-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_reporting"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Audit Service
  postgres-audit-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-audit-prod
    environment:
      POSTGRES_DB: dokus_audit
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5446:5432"
    volumes:
      - postgres-audit-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_audit"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database for Banking Service
  postgres-banking-prod:
    image: postgres:17-alpine
    container_name: dokus-postgres-banking-prod
    environment:
      POSTGRES_DB: dokus_banking
      POSTGRES_USER: ${DB_USERNAME:-produser}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5447:5432"
    volumes:
      - postgres-banking-prod:/var/lib/postgresql/data
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-produser} -d dokus_banking"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Shared Redis
  redis-prod:
    image: redis:8-alpine
    container_name: dokus-redis-prod
    ports:
      - "6379:6379"
    volumes:
      - redis-data-prod:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Auth Service
  auth-service-prod:
    image: invoid-vision/dokus-auth:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-auth-prod
    environment:
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-auth-prod:5432/dokus_auth
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_ISSUER: ${JWT_ISSUER:-https://dokus.ai}
      JWT_AUDIENCE: ${JWT_AUDIENCE:-dokus-api}
      REDIS_HOST: redis-prod
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      GEOIP_DATABASE_PATH: resources/GeoLite2-City.mmdb
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_PATH: /app/logs
    ports:
      - "6091:6091"
    depends_on:
      postgres-auth-prod:
        condition: service_healthy
      redis-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6091/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Invoicing Service
  invoicing-service-prod:
    image: invoid-vision/dokus-invoicing:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-invoicing-prod
    environment:
      PORT: 6092
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-invoicing-prod:5432/dokus_invoicing
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6092:6092"
    depends_on:
      postgres-invoicing-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6092/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Expense Service
  expense-service-prod:
    image: invoid-vision/dokus-expense:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-expense-prod
    environment:
      PORT: 6093
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-expense-prod:5432/dokus_expense
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6093:6093"
    depends_on:
      postgres-expense-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6093/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Payment Service
  payment-service-prod:
    image: invoid-vision/dokus-payment:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-payment-prod
    environment:
      PORT: 6094
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-payment-prod:5432/dokus_payment
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6094:6094"
    depends_on:
      postgres-payment-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6094/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Reporting Service
  reporting-service-prod:
    image: invoid-vision/dokus-reporting:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-reporting-prod
    environment:
      PORT: 6095
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-reporting-prod:5432/dokus_reporting
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6095:6095"
    depends_on:
      postgres-reporting-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6095/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Audit Service
  audit-service-prod:
    image: invoid-vision/dokus-audit:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-audit-prod
    environment:
      PORT: 6096
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-audit-prod:5432/dokus_audit
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6096:6096"
    depends_on:
      postgres-audit-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

  # Banking Service
  banking-service-prod:
    image: invoid-vision/dokus-banking:prod-${BUILD_NUMBER:-latest}
    container_name: dokus-banking-prod
    environment:
      PORT: 6097
      ENVIRONMENT: prod
      DB_URL: jdbc:postgresql://postgres-banking-prod:5432/dokus_banking
      DB_USERNAME: ${DB_USERNAME:-produser}
      DB_PASSWORD: ${DB_PASSWORD}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "6097:6097"
    depends_on:
      postgres-banking-prod:
        condition: service_healthy
    networks:
      - dokus-prod-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6097/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-prod:/app/logs
    restart: unless-stopped

networks:
  dokus-prod-network:
    driver: bridge

volumes:
  postgres-auth-prod:
  postgres-invoicing-prod:
  postgres-expense-prod:
  postgres-payment-prod:
  postgres-reporting-prod:
  postgres-audit-prod:
  postgres-banking-prod:
  redis-data-prod:
