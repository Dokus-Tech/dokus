ktor {
    deployment {
        # Single-server backend defaults
        port = 8080
        port = ${?PORT}
        host = "0.0.0.0"
        host = ${?HOST}

        # NOTE: ENVIRONMENT controls which application-<env>.conf is loaded.
        environment = "local"
        environment = ${?ENVIRONMENT}
    }
}

database {
    # Default for Docker compose profiles (service name: postgres)
    url = "jdbc:postgresql://postgres:5432/dokus"
    url = ${?DB_URL}
    username = "dokus"
    username = ${?DB_USERNAME}
    # In deployment profiles, set DB_PASSWORD in .env (required). Local dev overrides this in application-local.conf.
    password = ${DB_PASSWORD}
    driver = "org.postgresql.Driver"
    driver = ${?DB_DRIVER}

    pool {
        maxSize = 20
        maxSize = ${?DB_POOL_MAX_SIZE}
        minSize = 5
        minSize = ${?DB_POOL_MIN_SIZE}
        acquisitionTimeout = 30
        acquisitionTimeout = ${?DB_POOL_TIMEOUT}
        idleTimeout = 600
        idleTimeout = ${?DB_IDLE_TIMEOUT}
        maxLifetime = 1800
        maxLifetime = ${?DB_MAX_LIFETIME}
        leakDetectionThreshold = 30
        leakDetectionThreshold = ${?DB_LEAK_DETECTION}
    }
}

flyway {
    enabled = false
    enabled = ${?FLYWAY_ENABLED}
    baselineOnMigrate = true
    baselineOnMigrate = ${?FLYWAY_BASELINE_ON_MIGRATE}
    baselineVersion = "1.0.0"
    baselineVersion = ${?FLYWAY_BASELINE_VERSION}
    locations = ["classpath:db/migration"]
    schemas = ["public"]
}

jwt {
    issuer = "https://dokus.ai"
    issuer = ${?JWT_ISSUER}
    audience = "dokus-api"
    audience = ${?JWT_AUDIENCE}
    realm = "Access to Dokus API"
    realm = ${?JWT_REALM}

    # MVP: HS256 only (HMAC secret). Set via env in prod.
    secret = "local-secret-key"
    secret = ${?JWT_SECRET}
    algorithm = "HS256"
    algorithm = ${?JWT_ALGORITHM}
}

auth {
    maxLoginAttempts = 5
    maxLoginAttempts = ${?AUTH_MAX_LOGIN_ATTEMPTS}
    lockDurationMinutes = 30
    lockDurationMinutes = ${?AUTH_LOCK_DURATION_MINUTES}
    sessionDurationHours = 8
    sessionDurationHours = ${?AUTH_SESSION_DURATION_HOURS}
    rememberMeDurationDays = 30
    rememberMeDurationDays = ${?AUTH_REMEMBER_ME_DURATION_DAYS}
    maxConcurrentSessions = 3
    maxConcurrentSessions = ${?AUTH_MAX_CONCURRENT_SESSIONS}

    password {
        expiryDays = 90
        expiryDays = ${?AUTH_PASSWORD_EXPIRY_DAYS}
        minLength = 10
        minLength = ${?AUTH_PASSWORD_MIN_LENGTH}
        requireUppercase = true
        requireUppercase = ${?AUTH_PASSWORD_REQUIRE_UPPERCASE}
        requireLowercase = true
        requireLowercase = ${?AUTH_PASSWORD_REQUIRE_LOWERCASE}
        requireDigits = true
        requireDigits = ${?AUTH_PASSWORD_REQUIRE_DIGITS}
        requireSpecialChars = true
        requireSpecialChars = ${?AUTH_PASSWORD_REQUIRE_SPECIAL_CHARS}
        historySize = 5
        historySize = ${?AUTH_PASSWORD_HISTORY_SIZE}
    }

    rateLimit {
        windowSeconds = 60
        windowSeconds = ${?AUTH_RATE_LIMIT_WINDOW_SECONDS}
        maxAttempts = 10
        maxAttempts = ${?AUTH_RATE_LIMIT_MAX_ATTEMPTS}
    }

    enableDeviceFingerprinting = true
    enableDeviceFingerprinting = ${?AUTH_ENABLE_DEVICE_FINGERPRINTING}
    enableSessionSlidingExpiration = true
    enableSessionSlidingExpiration = ${?AUTH_ENABLE_SESSION_SLIDING_EXPIRATION}
    sessionActivityWindowMinutes = 15
    sessionActivityWindowMinutes = ${?AUTH_SESSION_ACTIVITY_WINDOW_MINUTES}
    logSecurityEvents = true
    logSecurityEvents = ${?AUTH_LOG_SECURITY_EVENTS}
    enableDebugMode = false
    enableDebugMode = ${?AUTH_ENABLE_DEBUG_MODE}
}

email {
    resend {
        apiKey = ${RESEND_API_KEY}
    }

    fromAddress = "Dokus <noreply@dokus.tech>"
    fromAddress = ${?EMAIL_FROM_ADDRESS}

    welcome {
        fromAddress = ${EMAIL_WELCOME_FROM_ADDRESS}
        replyToAddress = ${EMAIL_WELCOME_REPLY_TO_ADDRESS}
    }

    templates {
        baseUrl = "http://localhost:8081"
        baseUrl = ${?EMAIL_BASE_URL}
        supportEmail = "support@dokus.tech"
        supportEmail = ${?EMAIL_SUPPORT_ADDRESS}
        notificationPreferencesPath = "/settings/notifications"
        notificationPreferencesPath = ${?EMAIL_NOTIFICATION_PREFERENCES_PATH}
    }
}

logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
    consoleJson = false
    consoleJson = ${?LOG_CONSOLE_JSON}
}

metrics {
    enabled = true
    enabled = ${?METRICS_ENABLED}
    prometheusPath = "/metrics"
    prometheusPath = ${?METRICS_PROMETHEUS_PATH}
}

security {
    cors {
        allowedHosts = ["localhost:8080", "localhost:8081", "127.0.0.1:8080"]
        allowedHosts = ${?CORS_ALLOWED_HOSTS}
    }
}

caching {
    type = "memory"
    ttl = 3600
    ttl = ${?CACHE_TTL}
    maxSize = 1000
    maxSize = ${?CACHE_MAX_SIZE}

    redis {
        host = "localhost"
        host = ${?REDIS_HOST}
        port = 6379
        port = ${?REDIS_PORT}
        password = ""
        password = ${?REDIS_PASSWORD}
        database = 0
        database = ${?REDIS_DATABASE}

        pool {
            maxTotal = 8
            maxTotal = ${?REDIS_POOL_MAX_TOTAL}
            maxIdle = 4
            maxIdle = ${?REDIS_POOL_MAX_IDLE}
            minIdle = 0
            minIdle = ${?REDIS_POOL_MIN_IDLE}
            testOnBorrow = true
            testOnBorrow = ${?REDIS_POOL_TEST_ON_BORROW}
        }

        timeout {
            connection = 2000
            connection = ${?REDIS_TIMEOUT_CONNECTION}
            socket = 2000
            socket = ${?REDIS_TIMEOUT_SOCKET}
            command = 2000
            command = ${?REDIS_TIMEOUT_COMMAND}
        }
    }
}

server {
    name = "Dokus Server"
    name = ${?SERVER_NAME}
    version = "0.1.0"
    version = ${?SERVER_VERSION}
    environment = "local"
    environment = ${?ENVIRONMENT}
    bankingEnabled = true
    bankingEnabled = ${?BANKING_ENABLED}
    paymentsEnabled = true
    paymentsEnabled = ${?PAYMENTS_ENABLED}
}

storage {
    publicUrl = ""
    publicUrl = ${?STORAGE_PUBLIC_URL}
}

# Shared MinIO for documents + avatars.
minio {
    endpoint = "http://minio:9000"
    endpoint = ${?MINIO_ENDPOINT}
    accessKey = "dokusadmin"
    accessKey = ${?MINIO_ACCESS_KEY}
    # Use the same secret as the MinIO root password (MINIO_PASSWORD in .env).
    secretKey = ${MINIO_PASSWORD}
    secretKey = ${?MINIO_SECRET_KEY}
    bucket = "dokus-storage"
    bucket = ${?MINIO_BUCKET}
}

# Optional: Belgian CBE lookup API (used in /api/v1/lookup/cbe)
cbe {
    apiSecret = "rK1Enmltoey8DYnw5raPnPNFN1xuoGxG"
    apiSecret = ${?CBE_API_SECRET}
}

# Peppol module configuration (used by cashflow endpoints).
peppol {
    defaultProvider = "recommand"
    defaultProvider = ${?PEPPOL_DEFAULT_PROVIDER}

    globalTestMode = false
    globalTestMode = ${?PEPPOL_GLOBAL_TEST_MODE}

    # Note: Provider URLs are defined in PeppolProviderConfig sealed class
    # (URLs are fixed, only API keys differ between environments)

    inbox {
        pollingEnabled = true
        pollingEnabled = ${?PEPPOL_INBOX_POLLING_ENABLED}
        pollingIntervalSeconds = 600
        pollingIntervalSeconds = ${?PEPPOL_INBOX_POLLING_INTERVAL_SECONDS}
    }

    # Master Peppol credentials (required for all deployments)
    # Get API keys from https://app.recommand.eu/api-keys
    master {
        apiKey = ${PEPPOL_MASTER_API_KEY}
        apiSecret = ${PEPPOL_MASTER_API_SECRET}
    }

    webhookSecurity {
        enabled = true
        enabled = ${?PEPPOL_WEBHOOK_SECURITY_ENABLED}
        sharedSecret = ${PEPPOL_WEBHOOK_SHARED_SECRET}
        sharedSecret = ${?PEPPOL_WEBHOOK_SHARED_SECRET}
        timestampHeader = "X-Recommand-Timestamp"
        timestampHeader = ${?PEPPOL_WEBHOOK_TIMESTAMP_HEADER}
        signatureHeader = "X-Recommand-Signature"
        signatureHeader = ${?PEPPOL_WEBHOOK_SIGNATURE_HEADER}
        maxSkewSeconds = 300
        maxSkewSeconds = ${?PEPPOL_WEBHOOK_MAX_SKEW_SECONDS}
    }
}

# AI configuration (IntelligenceMode).
# Mode is the single source of truth for model selection, processing strategy, and autonomy:
# - assisted:   Raspberry Pi / edge (≤16GB RAM) - single-pass extraction, no parallelism
# - autonomous: MacBook Pro M4 Max (36-48GB RAM) - sequential ensemble, validation and retries
# - sovereign:  Mac Studio M4 Max (≥128GB RAM) - parallel agents, deep self-correction
ai {
    mode = "autonomous"
    mode = ${?DOKUS_INTELLIGENCE_MODE}

    ollama-host = "http://localhost:11434"
    ollama-host = ${?OLLAMA_HOST}

    lm-studio-host = "http://localhost:1234/v1"
    lm-studio-host = ${?LM_STUDIO_HOST}
}

# Document processor worker settings.
# Uses AI configuration from the 'ai' section above.
# Processing is always enabled - documents must be processed.
processor {
    pollingInterval = 5000
    pollingInterval = ${?PROCESSOR_POLLING_INTERVAL}

    maxAttempts = 3
    maxAttempts = ${?PROCESSOR_MAX_ATTEMPTS}

    batchSize = 10
    batchSize = ${?PROCESSOR_BATCH_SIZE}
}
