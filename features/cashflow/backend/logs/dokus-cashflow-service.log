2025-12-26 16:47:57,816 [DefaultDispatcher-worker-23 @coroutine#24] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-26 @coroutine#30] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-15 @coroutine#14] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,820 [DefaultDispatcher-worker-15 @coroutine#14] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,820 [DefaultDispatcher-worker-31 @coroutine#33] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,821 [DefaultDispatcher-worker-1 @coroutine#2] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-62 @coroutine#59] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-48 @coroutine#50] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-27 @coroutine#26] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,824 [DefaultDispatcher-worker-27 @coroutine#26] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-4 @coroutine#5] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,826 [DefaultDispatcher-worker-4 @coroutine#5] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,817 [DefaultDispatcher-worker-23 @coroutine#24] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-29 @coroutine#28] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-61 @coroutine#60] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-55 @coroutine#53] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,817 [DefaultDispatcher-worker-13 @coroutine#17] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,830 [DefaultDispatcher-worker-13 @coroutine#17] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-16 @coroutine#15] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,817 [DefaultDispatcher-worker-42 @coroutine#40] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,817 [DefaultDispatcher-worker-56 @coroutine#62] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-41 @coroutine#41] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-5 @coroutine#9] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,818 [DefaultDispatcher-worker-63 @coroutine#63] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,816 [DefaultDispatcher-worker-28 @coroutine#29] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-34 @coroutine#39] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,815 [DefaultDispatcher-worker-11 @coroutine#10] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,837 [DefaultDispatcher-worker-11 @coroutine#10] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,818 [DefaultDispatcher-worker-18 @coroutine#19] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,818 [DefaultDispatcher-worker-19 @coroutine#18] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,819 [DefaultDispatcher-worker-50 @coroutine#49] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,819 [DefaultDispatcher-worker-43 @coroutine#52] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,819 [DefaultDispatcher-worker-26 @coroutine#30] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,819 [DefaultDispatcher-worker-66 @coroutine#65] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,820 [DefaultDispatcher-worker-21 @coroutine#21] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,820 [DefaultDispatcher-worker-40 @coroutine#46] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,820 [DefaultDispatcher-worker-6 @coroutine#8] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,821 [DefaultDispatcher-worker-31 @coroutine#33] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,844 [DefaultDispatcher-worker-6 @coroutine#8] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,821 [DefaultDispatcher-worker-17 @coroutine#20] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,821 [DefaultDispatcher-worker-49 @coroutine#48] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,822 [DefaultDispatcher-worker-52 @coroutine#54] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$high concurrency stress test with 100 concurrent requests$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:353)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'e580cf36-1546-4659-a65c-eb95ef1495fd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,822 [DefaultDispatcher-worker-1 @coroutine#2] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,823 [DefaultDispatcher-worker-62 @coroutine#59] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,823 [DefaultDispatcher-worker-48 @coroutine#50] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,846 [DefaultDispatcher-worker-52 @coroutine#54] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,828 [DefaultDispatcher-worker-29 @coroutine#28] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,829 [DefaultDispatcher-worker-61 @coroutine#60] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,830 [DefaultDispatcher-worker-55 @coroutine#53] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,831 [DefaultDispatcher-worker-16 @coroutine#15] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,832 [DefaultDispatcher-worker-42 @coroutine#40] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,833 [DefaultDispatcher-worker-56 @coroutine#62] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,834 [DefaultDispatcher-worker-41 @coroutine#41] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,834 [DefaultDispatcher-worker-5 @coroutine#9] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,835 [DefaultDispatcher-worker-63 @coroutine#63] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,836 [DefaultDispatcher-worker-28 @coroutine#29] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,837 [DefaultDispatcher-worker-34 @coroutine#39] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,839 [DefaultDispatcher-worker-18 @coroutine#19] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,840 [DefaultDispatcher-worker-19 @coroutine#18] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,841 [DefaultDispatcher-worker-50 @coroutine#49] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,842 [DefaultDispatcher-worker-43 @coroutine#52] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,842 [DefaultDispatcher-worker-66 @coroutine#65] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,843 [DefaultDispatcher-worker-21 @coroutine#21] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,843 [DefaultDispatcher-worker-40 @coroutine#46] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,844 [DefaultDispatcher-worker-17 @coroutine#20] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,845 [DefaultDispatcher-worker-49 @coroutine#48] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,904 [DefaultDispatcher-worker-37 @coroutine#108] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,905 [DefaultDispatcher-worker-37 @coroutine#108] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,905 [DefaultDispatcher-worker-8 @coroutine#103] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,905 [DefaultDispatcher-worker-8 @coroutine#103] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,905 [DefaultDispatcher-worker-44 @coroutine#105] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,905 [DefaultDispatcher-worker-44 @coroutine#105] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,904 [DefaultDispatcher-worker-3 @coroutine#115] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,906 [DefaultDispatcher-worker-3 @coroutine#115] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,906 [DefaultDispatcher-worker-59 @coroutine#166] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant2Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:262)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,906 [DefaultDispatcher-worker-59 @coroutine#166] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,904 [DefaultDispatcher-worker-10 @coroutine#123] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,907 [DefaultDispatcher-worker-10 @coroutine#123] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,904 [DefaultDispatcher-worker-14 @coroutine#106] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,908 [DefaultDispatcher-worker-14 @coroutine#106] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,904 [DefaultDispatcher-worker-56 @coroutine#113] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant1Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:256)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '09e8301b-10f3-4f86-943f-81313fa70a73', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,908 [DefaultDispatcher-worker-56 @coroutine#113] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,906 [DefaultDispatcher-worker-54 @coroutine#164] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant2Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:262)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,909 [DefaultDispatcher-worker-54 @coroutine#164] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,907 [DefaultDispatcher-worker-70 @coroutine#163] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$different tenants get independent sequences concurrently$1$tenant2Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:262)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:11 */ UUID '86edda00-0cb8-4a4c-995e-4518b523edd1', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,910 [DefaultDispatcher-worker-70 @coroutine#163] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-50 @coroutine#224] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-52 @coroutine#208] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-19 @coroutine#220] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-53 @coroutine#243] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-27 @coroutine#247] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-38 @coroutine#249] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-17 @coroutine#250] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-60 @coroutine#252] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,937 [DefaultDispatcher-worker-25 @coroutine#228] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,937 [DefaultDispatcher-worker-18 @coroutine#227] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-36 @coroutine#215] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-41 @coroutine#230] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-21 @coroutine#204] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,937 [DefaultDispatcher-worker-7 @coroutine#223] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,939 [DefaultDispatcher-worker-32 @coroutine#214] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-37 @coroutine#205] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,939 [DefaultDispatcher-worker-10 @coroutine#219] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,939 [DefaultDispatcher-worker-22 @coroutine#209] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,937 [DefaultDispatcher-worker-31 @coroutine#226] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,939 [DefaultDispatcher-worker-55 @coroutine#216] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-61 @coroutine#231] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,940 [DefaultDispatcher-worker-9 @coroutine#212] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-3 @coroutine#222] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,941 [DefaultDispatcher-worker-49 @coroutine#213] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-51 @coroutine#229] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,942 [DefaultDispatcher-worker-43 @coroutine#207] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-34 @coroutine#221] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,942 [DefaultDispatcher-worker-46 @coroutine#206] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-2 @coroutine#217] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,942 [DefaultDispatcher-worker-42 @coroutine#211] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-23 @coroutine#232] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,944 [DefaultDispatcher-worker-70 @coroutine#210] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-58 @coroutine#234] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-14 @coroutine#235] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-57 @coroutine#233] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-6 @coroutine#238] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,945 [DefaultDispatcher-worker-50 @coroutine#224] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,947 [DefaultDispatcher-worker-50 @coroutine#224] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-39 @coroutine#240] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,947 [DefaultDispatcher-worker-61 @coroutine#231] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-56 @coroutine#241] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,948 [DefaultDispatcher-worker-61 @coroutine#231] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-40 @coroutine#237] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,948 [DefaultDispatcher-worker-25 @coroutine#228] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-25 @coroutine#228] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-68 @coroutine#239] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-31 @coroutine#226] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0005, sequence_number=5, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-34 @coroutine#221] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0001, sequence_number=1, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-61 @coroutine#231] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0007, sequence_number=7, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-32 @coroutine#214] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0002, sequence_number=2, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-69 @coroutine#236] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-70 @coroutine#210] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0008, sequence_number=8, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-62 @coroutine#242] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-28 @coroutine#244] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-18 @coroutine#227] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-18 @coroutine#227] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-24 @coroutine#245] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,950 [DefaultDispatcher-worker-3 @coroutine#222] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,950 [DefaultDispatcher-worker-2 @coroutine#217] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0009, sequence_number=9, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,950 [DefaultDispatcher-worker-3 @coroutine#222] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-64 @coroutine#246] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,950 [DefaultDispatcher-worker-21 @coroutine#204] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0010, sequence_number=10, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-13 @coroutine#251] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-26 @coroutine#253] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,938 [DefaultDispatcher-worker-8 @coroutine#248] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,937 [DefaultDispatcher-worker-44 @coroutine#225] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,939 [DefaultDispatcher-worker-16 @coroutine#218] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Starting invoice number generation: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa
2025-12-26 16:47:57,952 [DefaultDispatcher-worker-69 @coroutine#236] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0011, sequence_number=11, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-10 @coroutine#219] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,952 [DefaultDispatcher-worker-58 @coroutine#234] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0012, sequence_number=12, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-37 @coroutine#205] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-60 @coroutine#252] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-17 @coroutine#250] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-7 @coroutine#223] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,946 [DefaultDispatcher-worker-55 @coroutine#216] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,947 [DefaultDispatcher-worker-9 @coroutine#212] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,947 [DefaultDispatcher-worker-41 @coroutine#230] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-49 @coroutine#213] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0003, sequence_number=3, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-27 @coroutine#247] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0016, sequence_number=16, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-41 @coroutine#230] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-38 @coroutine#249] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0006, sequence_number=6, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,949 [DefaultDispatcher-worker-6 @coroutine#238] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0004, sequence_number=4, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,952 [DefaultDispatcher-worker-52 @coroutine#208] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.generateInvoiceNumber-gA0cg78(InvoiceNumberGenerator.kt:81)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$full invoice number generation produces unique formatted numbers concurrently$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:294)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '903089c1-9eaa-4e2e-afc4-a0877788e9aa', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 40 common frames omitted
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-3 @coroutine#222] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0017, sequence_number=17, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,952 [DefaultDispatcher-worker-10 @coroutine#219] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,953 [DefaultDispatcher-worker-37 @coroutine#205] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,953 [DefaultDispatcher-worker-51 @coroutine#229] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0013, sequence_number=13, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,953 [DefaultDispatcher-worker-60 @coroutine#252] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,953 [DefaultDispatcher-worker-23 @coroutine#232] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0014, sequence_number=14, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,953 [DefaultDispatcher-worker-17 @coroutine#250] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,955 [DefaultDispatcher-worker-25 @coroutine#228] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0018, sequence_number=18, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-14 @coroutine#235] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0015, sequence_number=15, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-7 @coroutine#223] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-55 @coroutine#216] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,955 [DefaultDispatcher-worker-44 @coroutine#225] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0019, sequence_number=19, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-9 @coroutine#212] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,954 [DefaultDispatcher-worker-52 @coroutine#208] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,956 [DefaultDispatcher-worker-68 @coroutine#239] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0020, sequence_number=20, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,956 [DefaultDispatcher-worker-8 @coroutine#248] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0021, sequence_number=21, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,956 [DefaultDispatcher-worker-62 @coroutine#242] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0022, sequence_number=22, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,957 [DefaultDispatcher-worker-36 @coroutine#215] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0023, sequence_number=23, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,957 [DefaultDispatcher-worker-52 @coroutine#208] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0024, sequence_number=24, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,957 [DefaultDispatcher-worker-39 @coroutine#240] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0025, sequence_number=25, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,958 [DefaultDispatcher-worker-9 @coroutine#212] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0026, sequence_number=26, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,958 [DefaultDispatcher-worker-41 @coroutine#230] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0027, sequence_number=27, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,958 [DefaultDispatcher-worker-40 @coroutine#237] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0028, sequence_number=28, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,959 [DefaultDispatcher-worker-22 @coroutine#209] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0029, sequence_number=29, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,959 [DefaultDispatcher-worker-26 @coroutine#253] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0030, sequence_number=30, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,959 [DefaultDispatcher-worker-57 @coroutine#233] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0031, sequence_number=31, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,959 [DefaultDispatcher-worker-60 @coroutine#252] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0032, sequence_number=32, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,960 [DefaultDispatcher-worker-19 @coroutine#220] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0033, sequence_number=33, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,960 [DefaultDispatcher-worker-17 @coroutine#250] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0034, sequence_number=34, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,960 [DefaultDispatcher-worker-50 @coroutine#224] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0035, sequence_number=35, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,961 [DefaultDispatcher-worker-37 @coroutine#205] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0036, sequence_number=36, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,961 [DefaultDispatcher-worker-24 @coroutine#245] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0037, sequence_number=37, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,962 [DefaultDispatcher-worker-55 @coroutine#216] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0038, sequence_number=38, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,962 [DefaultDispatcher-worker-42 @coroutine#211] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0039, sequence_number=39, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,962 [DefaultDispatcher-worker-7 @coroutine#223] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0040, sequence_number=40, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,963 [DefaultDispatcher-worker-64 @coroutine#246] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0041, sequence_number=41, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,963 [DefaultDispatcher-worker-56 @coroutine#241] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0042, sequence_number=42, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,963 [DefaultDispatcher-worker-13 @coroutine#251] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0043, sequence_number=43, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,963 [DefaultDispatcher-worker-28 @coroutine#244] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0044, sequence_number=44, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,964 [DefaultDispatcher-worker-16 @coroutine#218] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0045, sequence_number=45, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,964 [DefaultDispatcher-worker-18 @coroutine#227] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0046, sequence_number=46, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,964 [DefaultDispatcher-worker-10 @coroutine#219] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0047, sequence_number=47, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,965 [DefaultDispatcher-worker-46 @coroutine#206] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0048, sequence_number=48, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,965 [DefaultDispatcher-worker-53 @coroutine#243] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0049, sequence_number=49, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,965 [DefaultDispatcher-worker-43 @coroutine#207] INFO  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invoice number generated: tenant_id=903089c1-9eaa-4e2e-afc4-a0877788e9aa, generated_number=INV-2025-0050, sequence_number=50, year=2025, prefix=INV, yearly_reset=true
2025-12-26 16:47:57,976 [DefaultDispatcher-worker-16 @coroutine#259] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$100 concurrent requests produce 100 unique sequential numbers$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:135)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,979 [DefaultDispatcher-worker-16 @coroutine#259] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,979 [DefaultDispatcher-worker-17 @coroutine#270] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$100 concurrent requests produce 100 unique sequential numbers$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:135)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,979 [DefaultDispatcher-worker-24 @coroutine#268] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$100 concurrent requests produce 100 unique sequential numbers$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:135)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '9a0a79aa-8edd-458d-910f-7067256b1bbd', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:57,979 [DefaultDispatcher-worker-24 @coroutine#268] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:57,979 [DefaultDispatcher-worker-17 @coroutine#270] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,019 [DefaultDispatcher-worker-71 @coroutine#384] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent requests across different years produce independent sequences$1$year2025Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:397)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,019 [DefaultDispatcher-worker-71 @coroutine#384] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,020 [DefaultDispatcher-worker-50 @coroutine#364] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2024)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2024)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent requests across different years produce independent sequences$1$year2024Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:391)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2024)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,021 [DefaultDispatcher-worker-68 @coroutine#381] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent requests across different years produce independent sequences$1$year2025Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:397)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,021 [DefaultDispatcher-worker-50 @coroutine#364] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,022 [DefaultDispatcher-worker-68 @coroutine#381] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,021 [DefaultDispatcher-worker-25 @coroutine#385] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent requests across different years produce independent sequences$1$year2025Deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:397)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:2 */ UUID '1ea9245c-62fa-49da-b6da-279872bf8b35', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,022 [DefaultDispatcher-worker-25 @coroutine#385] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,036 [DefaultDispatcher-worker-9 @coroutine#414] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,036 [DefaultDispatcher-worker-9 @coroutine#414] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,041 [DefaultDispatcher-worker-27 @coroutine#410] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:1 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2025)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,041 [DefaultDispatcher-worker-27 @coroutine#410] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,055 [DefaultDispatcher-worker-13 @coroutine#466] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,056 [DefaultDispatcher-worker-13 @coroutine#466] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,055 [DefaultDispatcher-worker-36 @coroutine#472] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,059 [DefaultDispatcher-worker-33 @coroutine#460] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,059 [DefaultDispatcher-worker-33 @coroutine#460] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,056 [DefaultDispatcher-worker-78 @coroutine#464] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,056 [DefaultDispatcher-worker-75 @coroutine#458] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,056 [DefaultDispatcher-worker-69 @coroutine#471] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,059 [DefaultDispatcher-worker-36 @coroutine#472] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,060 [DefaultDispatcher-worker-69 @coroutine#471] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,055 [DefaultDispatcher-worker-30 @coroutine#473] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:5 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2026)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,060 [DefaultDispatcher-worker-30 @coroutine#473] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,060 [DefaultDispatcher-worker-78 @coroutine#464] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,060 [DefaultDispatcher-worker-75 @coroutine#458] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,070 [DefaultDispatcher-worker-23 @coroutine#513] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,070 [DefaultDispatcher-worker-23 @coroutine#513] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,071 [DefaultDispatcher-worker-14 @coroutine#514] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,072 [DefaultDispatcher-worker-14 @coroutine#514] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,072 [DefaultDispatcher-worker-52 @coroutine#509] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,072 [DefaultDispatcher-worker-52 @coroutine#509] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,070 [DefaultDispatcher-worker-78 @coroutine#517] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,072 [DefaultDispatcher-worker-78 @coroutine#517] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,070 [DefaultDispatcher-worker-33 @coroutine#521] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,073 [DefaultDispatcher-worker-33 @coroutine#521] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,070 [DefaultDispatcher-worker-30 @coroutine#515] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,071 [DefaultDispatcher-worker-22 @coroutine#510] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,073 [DefaultDispatcher-worker-30 @coroutine#515] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,072 [DefaultDispatcher-worker-63 @coroutine#511] WARN  Exposed MDC={} - Transaction attempt #0 failed: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]. Statement(s): INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)
org.jetbrains.exposed.v1.exceptions.ExposedSQLException: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
SQL: [INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?)]
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:158)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec$lambda$21(JdbcTransaction.kt:236)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:47)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:232)
	at org.jetbrains.exposed.v1.jdbc.JdbcTransaction.exec(JdbcTransaction.kt:208)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutable$DefaultImpls.execute(BlockingExecutable.kt:76)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execute(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.QueriesKt.insert(Queries.kt:232)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal_gce3L2w$lambda$0$0(InvoiceNumberRepository.kt:92)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend$lambda$0(DatabaseFactory.kt:114)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction$lambda$5(Transactions.kt:192)
	at org.jetbrains.exposed.v1.core.transactions.TransactionsKt.withThreadLocalTransaction(Transactions.kt:53)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.inTopLevelTransaction(Transactions.kt:188)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction(Transactions.kt:135)
	at org.jetbrains.exposed.v1.jdbc.transactions.TransactionsKt.transaction$default(Transactions.kt:107)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invokeSuspend(DatabaseFactory.kt:110)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt$dbQuery$2.invoke(DatabaseFactory.kt)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndspatched(Undispatched.kt:66)
	at kotlinx.coroutines.intrinsics.UndispatchedKt.startUndispatchedOrReturn(Undispatched.kt:43)
	at kotlinx.coroutines.BuildersKt__Builders_commonKt.withContext(Builders.common.kt:165)
	at kotlinx.coroutines.BuildersKt.withContext(Unknown Source)
	at ai.dokus.foundation.ktor.database.DatabaseFactoryKt.dbQuery(DatabaseFactory.kt:109)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:64)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.access$getAndIncrementSequenceInternal-gce3L2w(InvoiceNumberRepository.kt:27)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invokeSuspend(InvoiceNumberRepository.kt:52)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository$getAndIncrementSequence$2.invoke(InvoiceNumberRepository.kt)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.retryOnDeadlock-gIAlu-s(InvoiceNumberRepository.kt:186)
	at ai.dokus.foundation.database.repository.cashflow.InvoiceNumberRepository.getAndIncrementSequence-gce3L2w(InvoiceNumberRepository.kt:51)
	at ai.dokus.cashflow.backend.InvoiceNumberConcurrencyTest$concurrent number generation is consistent across multiple runs$1$1$deferreds$1$1.invokeSuspend(InvoiceNumberConcurrencyTest.kt:196)
	at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:34)
	at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:100)
	at kotlinx.coroutines.internal.LimitedDispatcher$Worker.run(LimitedDispatcher.kt:124)
	at kotlinx.coroutines.scheduling.TaskImpl.run(Tasks.kt:89)
	at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:586)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:820)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:717)
	at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:704)
Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: "PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE INDEX PUBLIC.INVOICE_NUMBER_SEQUENCES_TENANT_ID_YEAR_UNIQUE_INDEX_2 ON PUBLIC.INVOICE_NUMBER_SEQUENCES(TENANT_ID NULLS FIRST, ""year"" NULLS FIRST) VALUES ( /* key:15 */ UUID 'd97f941d-dd75-48aa-9eca-cc6b73079f7b', 2027)"; SQL statement:
INSERT INTO INVOICE_NUMBER_SEQUENCES (ID, TENANT_ID, "year", CURRENT_NUMBER) VALUES (?, ?, ?, ?) [23505-240]
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:520)
	at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)
	at org.h2.message.DbException.get(DbException.java:223)
	at org.h2.message.DbException.get(DbException.java:199)
	at org.h2.index.Index.getDuplicateKeyException(Index.java:535)
	at org.h2.mvstore.db.MVSecondaryIndex.checkUnique(MVSecondaryIndex.java:223)
	at org.h2.mvstore.db.MVSecondaryIndex.add(MVSecondaryIndex.java:184)
	at org.h2.mvstore.db.MVTable.addRow(MVTable.java:520)
	at org.h2.command.dml.Insert.insertRows(Insert.java:174)
	at org.h2.command.dml.Insert.update(Insert.java:135)
	at org.h2.command.dml.DataChangeStatement.update(DataChangeStatement.java:77)
	at org.h2.command.CommandContainer.update(CommandContainer.java:139)
	at org.h2.command.Command.executeUpdate(Command.java:306)
	at org.h2.command.Command.executeUpdate(Command.java:250)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:213)
	at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:172)
	at org.jetbrains.exposed.v1.jdbc.statements.jdbc.JdbcPreparedStatementImpl.executeUpdate(JdbcPreparedStatementImpl.kt:55)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.execInsertFunction(InsertBlockingExecutable.kt:22)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:34)
	at org.jetbrains.exposed.v1.jdbc.statements.InsertBlockingExecutable.executeInternal(InsertBlockingExecutable.kt:18)
	at org.jetbrains.exposed.v1.jdbc.statements.BlockingExecutableKt.executeIn(BlockingExecutable.kt:156)
	... 39 common frames omitted
2025-12-26 16:47:58,073 [DefaultDispatcher-worker-63 @coroutine#511] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,073 [DefaultDispatcher-worker-22 @coroutine#510] WARN  Exposed MDC={} - Wait 0 milliseconds before retrying
2025-12-26 16:47:58,114 [Test worker] WARN  a.d.f.d.s.InvoiceNumberGenerator MDC={} - Invalid timezone 'Invalid/Timezone', falling back to Europe/Brussels
java.time.zone.ZoneRulesException: Unknown time-zone ID: Invalid/Timezone
	at java.base/java.time.zone.ZoneRulesProvider.getProvider(ZoneRulesProvider.java:280)
	at java.base/java.time.zone.ZoneRulesProvider.getRules(ZoneRulesProvider.java:235)
	at java.base/java.time.ZoneRegion.ofId(ZoneRegion.java:121)
	at java.base/java.time.ZoneId.of(ZoneId.java:410)
	at java.base/java.time.ZoneId.of(ZoneId.java:358)
	at ai.dokus.foundation.database.services.InvoiceNumberGenerator.getCurrentYear(InvoiceNumberGenerator.kt:222)
	at ai.dokus.cashflow.backend.InvoiceNumberYearRolloverTest.invalid timezone falls back to Europe Brussels(InvoiceNumberYearRolloverTest.kt:279)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:701)
	at org.junit.platform.commons.support.ReflectionSupport.invokeMethod(ReflectionSupport.java:502)
	at org.junit.jupiter.engine.support.MethodReflectionUtils.invoke(MethodReflectionUtils.java:45)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:61)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:124)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:163)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:148)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:123)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:105)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:99)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:66)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:47)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:39)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:104)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:98)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invokeVoid(InterceptingExecutableInvoker.java:71)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$0(TestMethodTestDescriptor.java:219)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:215)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:157)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:70)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$2(NodeTestTask.java:176)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$1(NodeTestTask.java:166)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$0(NodeTestTask.java:164)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:163)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:116)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:42)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$2(NodeTestTask.java:180)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$1(NodeTestTask.java:166)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$0(NodeTestTask.java:164)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:163)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:116)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:42)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$2(NodeTestTask.java:180)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$1(NodeTestTask.java:166)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:138)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$0(NodeTestTask.java:164)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:74)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:163)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:116)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:36)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:52)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:58)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.executeEngine(EngineExecutionOrchestrator.java:246)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.failOrExecuteEngine(EngineExecutionOrchestrator.java:218)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:179)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:108)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:66)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:157)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:65)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:125)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:93)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:48)
	at org.junit.platform.launcher.core.InterceptingLauncher.lambda$execute$0(InterceptingLauncher.java:41)
	at org.junit.platform.launcher.core.ClasspathAlignmentCheckingLauncherInterceptor.intercept(ClasspathAlignmentCheckingLauncherInterceptor.java:25)
	at org.junit.platform.launcher.core.InterceptingLauncher.execute(InterceptingLauncher.java:40)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:48)
	at org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.processAllTestClasses(JUnitPlatformTestClassProcessor.java:124)
	at org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.access$000(JUnitPlatformTestClassProcessor.java:99)
	at org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor.stop(JUnitPlatformTestClassProcessor.java:94)
	at org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.stop(SuiteTestClassProcessor.java:63)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36)
	at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)
	at org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:33)
	at org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:92)
	at jdk.proxy1/jdk.proxy1.$Proxy4.stop(Unknown Source)
	at org.gradle.api.internal.tasks.testing.worker.TestWorker$3.run(TestWorker.java:200)
	at org.gradle.api.internal.tasks.testing.worker.TestWorker.executeAndMaintainThreadName(TestWorker.java:132)
	at org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:103)
	at org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:63)
	at org.gradle.process.internal.worker.child.ActionExecutionWorker.execute(ActionExecutionWorker.java:56)
	at org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:121)
	at org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:71)
	at worker.org.gradle.process.internal.worker.GradleWorkerMain.run(GradleWorkerMain.java:69)
	at worker.org.gradle.process.internal.worker.GradleWorkerMain.main(GradleWorkerMain.java:74)
