ktor {
    deployment {
        port = 8080
        port = ${?PORT}
        host = "0.0.0.0"
        host = ${?HOST}
        environment = "local"
        environment = ${?ENVIRONMENT}
    }

    application {
        modules = [ ai.dokus.cashflow.backend.ApplicationKt.module ]
    }
}

database {
    url = "jdbc:postgresql://localhost:15542/dokus_cashflow"
    url = ${?DB_URL}
    username = "dev"
    username = ${?DB_USERNAME}
    password = "devpassword"
    password = ${?DB_PASSWORD}

    pool {
        maxSize = 20
        maxSize = ${?DB_POOL_MAX_SIZE}
        minSize = 5
        minSize = ${?DB_POOL_MIN_SIZE}
        acquisitionTimeout = 30
        acquisitionTimeout = ${?DB_POOL_TIMEOUT}
        idleTimeout = 600
        idleTimeout = ${?DB_IDLE_TIMEOUT}
        maxLifetime = 1800
        maxLifetime = ${?DB_MAX_LIFETIME}
        leakDetectionThreshold = 30
        leakDetectionThreshold = ${?DB_LEAK_DETECTION}
    }
}

flyway {
    enabled = true
    baselineOnMigrate = true
    baselineVersion = "1.0.0"
    locations = ["classpath:db/migration"]
    schemas = ["public"]
}

jwt {
    issuer = "https://dokus.ai"
    issuer = ${?JWT_ISSUER}
    audience = "dokus-api"
    audience = ${?JWT_AUDIENCE}
    realm = "Access to Dokus API"
    secret = "secret"
    secret = ${?JWT_SECRET}
    publicKeyPath = "classpath:META-INF/resources/public-key.pem"
    publicKeyPath = ${?JWT_PUBLIC_KEY_PATH}
    privateKeyPath = "classpath:private-key.pem"
    privateKeyPath = ${?JWT_PRIVATE_KEY_PATH}
    algorithm = "RS256"
    algorithm = ${?JWT_ALGORITHM}
}

auth {
    # Auth service RPC connection
    serviceUrl = "http://localhost:7091/rpc"
    serviceUrl = ${?AUTH_SERVICE_URL}
    connectionTimeout = 5000  # milliseconds
    connectionTimeout = ${?AUTH_SERVICE_CONNECTION_TIMEOUT}
    requestTimeout = 10000  # milliseconds
    requestTimeout = ${?AUTH_SERVICE_REQUEST_TIMEOUT}

    maxLoginAttempts = 5
    maxLoginAttempts = ${?AUTH_MAX_LOGIN_ATTEMPTS}
    lockDurationMinutes = 30
    lockDurationMinutes = ${?AUTH_LOCK_DURATION_MINUTES}
    sessionDurationHours = 8
    sessionDurationHours = ${?AUTH_SESSION_DURATION_HOURS}
    rememberMeDurationDays = 30
    rememberMeDurationDays = ${?AUTH_REMEMBER_ME_DURATION_DAYS}
    maxConcurrentSessions = 3
    maxConcurrentSessions = ${?AUTH_MAX_CONCURRENT_SESSIONS}

    password {
        expiryDays = 90
        expiryDays = ${?AUTH_PASSWORD_EXPIRY_DAYS}
        minLength = 10
        minLength = ${?AUTH_PASSWORD_MIN_LENGTH}
        requireUppercase = true
        requireUppercase = ${?AUTH_PASSWORD_REQUIRE_UPPERCASE}
        requireLowercase = true
        requireLowercase = ${?AUTH_PASSWORD_REQUIRE_LOWERCASE}
        requireDigits = true
        requireDigits = ${?AUTH_PASSWORD_REQUIRE_DIGITS}
        requireSpecialChars = true
        requireSpecialChars = ${?AUTH_PASSWORD_REQUIRE_SPECIAL_CHARS}
        historySize = 5
        historySize = ${?AUTH_PASSWORD_HISTORY_SIZE}
    }

    rateLimit {
        windowSeconds = 60
        windowSeconds = ${?AUTH_RATE_LIMIT_WINDOW_SECONDS}
        maxAttempts = 10
        maxAttempts = ${?AUTH_RATE_LIMIT_MAX_ATTEMPTS}
    }

    enableDeviceFingerprinting = true
    enableDeviceFingerprinting = ${?AUTH_ENABLE_DEVICE_FINGERPRINTING}
    enableSessionSlidingExpiration = true
    enableSessionSlidingExpiration = ${?AUTH_ENABLE_SESSION_SLIDING_EXPIRATION}
    sessionActivityWindowMinutes = 15
    sessionActivityWindowMinutes = ${?AUTH_SESSION_ACTIVITY_WINDOW_MINUTES}
    logSecurityEvents = true
    logSecurityEvents = ${?AUTH_LOG_SECURITY_EVENTS}
    enableDebugMode = false
    enableDebugMode = ${?AUTH_ENABLE_DEBUG_MODE}
}

cashflow {
    documents {
        # Local filesystem storage for development
        storageType = "local"
        storageType = ${?STORAGE_TYPE}

        # Local storage settings
        localStoragePath = "./storage/documents"
        localStoragePath = ${?LOCAL_STORAGE_PATH}

        # S3 storage settings (for production)
        s3Bucket = "dokus-documents"
        s3Bucket = ${?S3_BUCKET}
        s3Region = "eu-west-1"
        s3Region = ${?S3_REGION}
        s3AccessKey = ""
        s3AccessKey = ${?S3_ACCESS_KEY}
        s3SecretKey = ""
        s3SecretKey = ${?S3_SECRET_KEY}

        # File upload limits
        maxFileSizeMb = 10
        maxFileSizeMb = ${?MAX_FILE_SIZE_MB}
        allowedContentTypes = ["application/pdf", "image/jpeg", "image/png", "image/jpg"]

        # Thumbnail generation
        enableThumbnails = true
        enableThumbnails = ${?ENABLE_THUMBNAILS}
        thumbnailWidth = 200
        thumbnailWidth = ${?THUMBNAIL_WIDTH}
        thumbnailHeight = 200
        thumbnailHeight = ${?THUMBNAIL_HEIGHT}
    }

    invoices {
        # Invoice number generation
        numberPrefix = "INV-"
        numberPrefix = ${?INVOICE_NUMBER_PREFIX}

        # Payment terms defaults
        defaultPaymentTermsDays = 30
        defaultPaymentTermsDays = ${?DEFAULT_PAYMENT_TERMS_DAYS}

        # Overdue invoice reminders
        overdueReminderDays = [7, 14, 21]

        # VAT rate (Belgium default 21%)
        defaultVatRate = 0.21
        defaultVatRate = ${?DEFAULT_VAT_RATE}
    }

    expenses {
        # Auto-categorization
        enableAutoCategorization = true
        enableAutoCategorization = ${?ENABLE_AUTO_CATEGORIZATION}

        # Receipt OCR
        enableOcr = false
        enableOcr = ${?ENABLE_OCR}
    }
}

logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
    consoleJson = false
    consoleJson = ${?LOG_CONSOLE_JSON}
}

metrics {
    enabled = true
    enabled = ${?METRICS_ENABLED}
    prometheusPath = "/metrics"
    prometheusPath = ${?METRICS_PROMETHEUS_PATH}
}

security {
    cors {
        allowedHosts = ["localhost:8081", "10.13.4.103:8080"]
        allowedHosts = ${?SECURITY_CORS_ALLOWED_HOSTS}
    }
}

caching {
    type = "memory"  # Default to memory, can be overridden to "redis"
    type = ${?CACHE_TYPE}
    ttl = 3600  # Default TTL in seconds (1 hour)
    ttl = ${?CACHE_TTL}
    maxSize = 1000  # Max entries for memory cache
    maxSize = ${?CACHE_MAX_SIZE}

    redis {
        host = "localhost"
        host = ${?REDIS_HOST}
        port = 6379
        port = ${?REDIS_PORT}
        password = ""
        password = ${?REDIS_PASSWORD}
        database = 0
        database = ${?REDIS_DATABASE}

        pool {
            maxTotal = 8
            maxTotal = ${?REDIS_POOL_MAX_TOTAL}
            maxIdle = 4
            maxIdle = ${?REDIS_POOL_MAX_IDLE}
            minIdle = 0
            minIdle = ${?REDIS_POOL_MIN_IDLE}
            testOnBorrow = true
            testOnBorrow = ${?REDIS_POOL_TEST_ON_BORROW}
        }

        timeout {
            connection = 2000  # milliseconds
            connection = ${?REDIS_TIMEOUT_CONNECTION}
            socket = 2000
            socket = ${?REDIS_TIMEOUT_SOCKET}
            command = 2000
            command = ${?REDIS_TIMEOUT_COMMAND}
        }
    }
}

email {
    enabled = false
    enabled = ${?EMAIL_ENABLED}
    provider = "disabled"  # "smtp" or "disabled"
    provider = ${?EMAIL_PROVIDER}

    smtp {
        host = "smtp.example.com"
        host = ${?SMTP_HOST}
        port = 587
        port = ${?SMTP_PORT}
        username = "noreply@dokus.ai"
        username = ${?SMTP_USERNAME}
        password = ""
        password = ${?SMTP_PASSWORD}
        enableTls = true
        enableTls = ${?SMTP_ENABLE_TLS}
        enableAuth = true
        enableAuth = ${?SMTP_ENABLE_AUTH}
        connectionTimeout = 10000
        connectionTimeout = ${?SMTP_CONNECTION_TIMEOUT}
        timeout = 10000
        timeout = ${?SMTP_TIMEOUT}
    }

    from {
        email = "noreply@dokus.ai"
        email = ${?EMAIL_FROM_ADDRESS}
        name = "Dokus"
        name = ${?EMAIL_FROM_NAME}
    }

    replyTo {
        email = "support@dokus.ai"
        email = ${?EMAIL_REPLY_TO_ADDRESS}
        name = "Dokus Support"
        name = ${?EMAIL_REPLY_TO_NAME}
    }

    templates {
        baseUrl = "http://localhost:8081"
        baseUrl = ${?EMAIL_BASE_URL}
        supportEmail = "support@dokus.ai"
        supportEmail = ${?EMAIL_SUPPORT_ADDRESS}
    }
}

rabbitmq {
    host = "localhost"
    host = ${?RABBITMQ_HOST}
    port = 5672
    port = ${?RABBITMQ_PORT}
    username = "dokus"
    username = ${?RABBITMQ_USERNAME}
    password = "dokus"
    password = ${?RABBITMQ_PASSWORD}
    virtualHost = "/dokus"
    virtualHost = ${?RABBITMQ_VHOST}
}
