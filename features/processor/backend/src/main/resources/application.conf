ktor {
    deployment {
        port = 8004
        port = ${?PORT}
        host = "0.0.0.0"
        host = ${?HOST}
        environment = "local"
        environment = ${?ENVIRONMENT}
    }

    application {
        modules = [ ai.dokus.processor.backend.ApplicationKt.module ]
    }
}

database {
    url = "jdbc:postgresql://localhost:15542/dokus_cashflow"
    url = ${?DB_URL}
    username = "dev"
    username = ${?DB_USERNAME}
    password = "devpassword"
    password = ${?DB_PASSWORD}

    pool {
        maxSize = 5
        maxSize = ${?DB_POOL_MAX_SIZE}
        minSize = 2
        minSize = ${?DB_POOL_MIN_SIZE}
        acquisitionTimeout = 30
        acquisitionTimeout = ${?DB_POOL_TIMEOUT}
        idleTimeout = 600
        idleTimeout = ${?DB_IDLE_TIMEOUT}
        maxLifetime = 1800
        maxLifetime = ${?DB_MAX_LIFETIME}
        leakDetectionThreshold = 30
        leakDetectionThreshold = ${?DB_LEAK_DETECTION}
    }
}

flyway {
    enabled = false
    baselineOnMigrate = true
    baselineVersion = "1.0.0"
    locations = ["classpath:db/migration"]
    schemas = ["public"]
}

jwt {
    issuer = "https://dokus.ai"
    issuer = ${?JWT_ISSUER}
    audience = "dokus-api"
    audience = ${?JWT_AUDIENCE}
    realm = "Access to Dokus API"
    secret = "secret"
    secret = ${?JWT_SECRET}
    publicKeyPath = "classpath:META-INF/resources/public-key.pem"
    publicKeyPath = ${?JWT_PUBLIC_KEY_PATH}
    privateKeyPath = "classpath:private-key.pem"
    privateKeyPath = ${?JWT_PRIVATE_KEY_PATH}
    algorithm = "RS256"
    algorithm = ${?JWT_ALGORITHM}
}

auth {
    serviceUrl = "http://localhost:7091/rpc"
    serviceUrl = ${?AUTH_SERVICE_URL}
    connectionTimeout = 5000
    connectionTimeout = ${?AUTH_SERVICE_CONNECTION_TIMEOUT}
    requestTimeout = 10000
    requestTimeout = ${?AUTH_SERVICE_REQUEST_TIMEOUT}
    maxLoginAttempts = 5
    lockDurationMinutes = 30
    sessionDurationHours = 8
    rememberMeDurationDays = 30
    maxConcurrentSessions = 3
    password {
        expiryDays = 90
        minLength = 10
        requireUppercase = true
        requireLowercase = true
        requireDigits = true
        requireSpecialChars = true
        historySize = 5
    }
    rateLimit {
        windowSeconds = 60
        maxAttempts = 10
    }
    enableDeviceFingerprinting = false
    enableSessionSlidingExpiration = true
    sessionActivityWindowMinutes = 15
    logSecurityEvents = true
    enableDebugMode = false
}

logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
    consoleJson = false
    consoleJson = ${?LOG_CONSOLE_JSON}
}

metrics {
    enabled = true
    enabled = ${?METRICS_ENABLED}
    prometheusPath = "/metrics"
    prometheusPath = ${?METRICS_PROMETHEUS_PATH}
}

security {
    cors {
        # Default allowed hosts for local development and web app
        # Format: "host:port" - both http and https schemes are allowed
        allowedHosts = ["localhost:8080", "localhost:8081", "127.0.0.1:8080"]
        allowedHosts = ${?CORS_ALLOWED_HOSTS}
    }
}

caching {
    type = "memory"
    type = ${?CACHE_TYPE}
    ttl = 3600
    ttl = ${?CACHE_TTL}
    maxSize = 1000
    maxSize = ${?CACHE_MAX_SIZE}

    redis {
        host = "localhost"
        host = ${?REDIS_HOST}
        port = 6379
        port = ${?REDIS_PORT}
        password = ""
        password = ${?REDIS_PASSWORD}
        database = 0
        database = ${?REDIS_DATABASE}
        pool {
            maxTotal = 8
            maxIdle = 4
            minIdle = 0
            testOnBorrow = true
        }
        timeout {
            connection = 2000
            socket = 2000
            command = 2000
        }
    }
}

rabbitmq {
    host = "rabbitmq"
    host = ${?RABBITMQ_HOST}
    port = 5672
    username = "dokus"
    password = ${RABBITMQ_PASSWORD}
    virtualHost = "/dokus"
}

minio {
    endpoint = "http://minio:9000"
    endpoint = ${?MINIO_ENDPOINT}
    accessKey = "dokus"
    accessKey = ${?MINIO_ACCESS_KEY}
    secretKey = "dokuspassword"
    secretKey = ${?MINIO_SECRET_KEY}
    bucket = "dokus-documents"
    bucket = ${?MINIO_BUCKET}
}

processor {
    pollingInterval = 5000
    pollingInterval = ${?PROCESSOR_POLLING_INTERVAL}

    maxAttempts = 3
    maxAttempts = ${?PROCESSOR_MAX_ATTEMPTS}

    batchSize = 10
    batchSize = ${?PROCESSOR_BATCH_SIZE}

    ai {
        defaultProvider = "openai"
        defaultProvider = ${?AI_DEFAULT_PROVIDER}

        openai {
            apiKey = ""
            apiKey = ${?OPENAI_API_KEY}
            model = "gpt-4o"
            model = ${?OPENAI_MODEL}
            baseUrl = "https://api.openai.com/v1"
            baseUrl = ${?OPENAI_BASE_URL}
        }

        anthropic {
            apiKey = ""
            apiKey = ${?ANTHROPIC_API_KEY}
            model = "claude-sonnet-4-20250514"
            model = ${?ANTHROPIC_MODEL}
            baseUrl = "https://api.anthropic.com"
            baseUrl = ${?ANTHROPIC_BASE_URL}
        }

        local {
            # Use host.docker.internal for Docker Desktop (macOS/Windows)
            baseUrl = "http://host.docker.internal:11434"
            baseUrl = ${?LOCAL_AI_BASE_URL}
            model = "llama3.2"
            model = ${?LOCAL_AI_MODEL}
        }
    }
}

server {
    name = "Dokus Processor"
    name = ${?SERVER_NAME}
    version = "1.0.0"
    version = ${?SERVER_VERSION}
    environment = "local"
    environment = ${?ENVIRONMENT}
    bankingEnabled = false
    paymentsEnabled = false
}
