networks:
  dokus-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  minio-data:
  traefik-acme:

x-jvm-cloud-defaults: &jvm-cloud-defaults
  JAVA_OPTS: >-
    -XX:+UseContainerSupport
    -XX:MaxRAMPercentage=75
    -XX:InitialRAMPercentage=50
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=100
    -XX:+UseStringDeduplication
    -Djava.security.egd=file:/dev/./urandom
    -Dfile.encoding=UTF-8

services:
  # =========================================================
  # Traefik (TLS termination + routing)
  # =========================================================
  traefik:
    image: traefik:v3.2
    container_name: dokus-traefik
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true

      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443

      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https

      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-contact@dokus.tech}
      - --certificatesresolvers.letsencrypt.acme.storage=/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web

      - --api.dashboard=true
      - --ping=true

      - --log.level=INFO
      - --accesslog=true

    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8080:8080"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./logs/traefik:/logs
      - traefik-acme:/acme

    networks:
      - dokus-network

    healthcheck:
      test: [ "CMD", "traefik", "healthcheck", "--ping" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================
  # Infra (not exposed publicly)
  # =========================================================
  postgres:
    image: pgvector/pgvector:pg17
    container_name: dokus-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: dokus
      POSTGRES_USER: dokus
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init-extensions.sql:/docker-entrypoint-initdb.d/init-extensions.sql:ro
    networks:
      - dokus-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U dokus -d dokus" ]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:8-alpine
    container_name: dokus-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - dokus-network
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} ping | grep PONG" ]
      interval: 10s
      timeout: 5s
      retries: 10

  minio:
    image: minio/minio:latest
    container_name: dokus-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: dokusadmin
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - dokus-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio.rule=Host(`${DOMAIN:-app.dokus.tech}`) && PathPrefix(`/storage`)"
      - "traefik.http.routers.minio.entrypoints=websecure"
      - "traefik.http.routers.minio.tls.certresolver=letsencrypt"
      - "traefik.http.services.minio.loadbalancer.server.port=9000"
      - "traefik.http.middlewares.minio-strip.stripprefix.prefixes=/storage"
      - "traefik.http.routers.minio.middlewares=minio-strip"

  # =========================================================
  # Backend (single server)
  # =========================================================
  dokus-server:
    image: ${DOCKER_REGISTRY:-docker.invoid.vision}/dokus-server:${TAG:-latest}
    container_name: dokus-server
    restart: unless-stopped
    env_file:
      - .env
    environment:
      <<: *jvm-cloud-defaults
      ENVIRONMENT: cloud
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: dokusadmin
      MINIO_SECRET_KEY: ${MINIO_PASSWORD}
      MINIO_BUCKET: dokus-storage
      # AI configuration (sovereign mode for cloud with max capability)
      DOKUS_INTELLIGENCE_MODE: sovereign
      OLLAMA_HOST: ${OLLAMA_HOST:-http://ollama:11434}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      LOG_PATH: /app/logs
    networks:
      - dokus-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    volumes:
      - ./logs/server:/app/logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${DOMAIN:-app.dokus.tech}`) && (PathPrefix(`/api`) || Path(`/health`) || Path(`/metrics`))"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api.middlewares=rate-limit@file,cors-api@file,compress@file"
      - "traefik.http.services.api.loadbalancer.server.port=8080"

