include "application.conf"

ktor {
    deployment {
        port = 8091
        port = ${?PORT}
        host = "0.0.0.0"
        environment = "production"
    }
}

database {
    url = "jdbc:postgresql://localhost:5441/auth"
    url = ${?DB_URL}
    username = ${DB_USERNAME}
    password = ${DB_PASSWORD}

    pool {
        maxPoolSize = 20
        minIdle = 5
        idleTimeout = 600000
        maxLifetime = 1800000
        connectionTimeout = 30000
    }
}

jwt {
    secret = ${JWT_SECRET}
    issuer = ${JWT_ISSUER}
    audience = ${JWT_AUDIENCE}
    realm = "Dokus Authentication"
}

security {
    cors {
        allowedHosts = ${CORS_ALLOWED_HOSTS}
    }

    apiKeys {
        monitoring = ${MONITORING_API_KEY}
        admin = ${ADMIN_API_KEY}
        integration = ${INTEGRATION_API_KEY}
    }

    requestSigning {
        enabled = true
        enabled = ${?REQUEST_SIGNING_ENABLED}
        secret = ${REQUEST_SIGNING_SECRET}
    }

    rateLimit {
        enabled = true
        requestsPerMinute = 60
        requestsPerMinute = ${?RATE_LIMIT_PER_MINUTE}
    }
}

caching {
    type = ${CACHE_TYPE} // "memory" or "redis"

    redis {
        host = ${?REDIS_HOST}
        port = ${?REDIS_PORT}
        password = ${?REDIS_PASSWORD}
        database = ${?REDIS_DATABASE}

        pool {
            maxTotal = 20
            maxIdle = 10
            minIdle = 2
            testOnBorrow = true
        }

        timeout {
            connection = 2000
            socket = 2000
            command = 2000
        }
    }

    maxSize = 10000
    ttl = 900 // 15 minutes
}

logging {
    level = "INFO"
    level = ${?LOG_LEVEL}
    console = false
    file = true

    file {
        path = "/var/log/dokus"
        path = ${?LOG_PATH}
        maxFileSize = "100MB"
        maxHistory = 30
        pattern = "%d{ISO8601} [%thread] %-5level %logger{36} - %msg%n"
    }

    // JSON format for production
    format = "json"
}

monitoring {
    metrics {
        enabled = true
        path = "/metrics"

        prometheus {
            enabled = true
            port = 9090
            port = ${?METRICS_PORT}
        }
    }

    health {
        enabled = true
        readyPath = "/health/ready"
        livePath = "/health/live"

        checks {
            database = true
            redis = true
            diskSpace = true
            memory = true
        }
    }

    tracing {
        enabled = ${?TRACING_ENABLED}
        serviceName = "dokus-database-service"
        endpoint = ${?JAEGER_ENDPOINT}
        samplingRate = 0.1
    }
}

flyway {
    enabled = true
    cleanDisabled = true
    baselineOnMigrate = false
    validateOnMigrate = true
}

// Production-specific optimizations
performance {
    connectionPooling {
        enabled = true
    }

    queryCache {
        enabled = true
        size = 5000
    }

    compression {
        enabled = true
        level = 6
    }
}