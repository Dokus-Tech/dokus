# Development Docker Compose configuration
# Each service has its own PostgreSQL database

services:
  # PostgreSQL Database for Auth Service
  postgres-auth-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-auth-local
    environment:
      POSTGRES_DB: dokus_auth
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15541:5432"
    volumes:
      - postgres-auth-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_auth"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Cashflow Service (Invoice + Expense merged)
  postgres-cashflow-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-cashflow-local
    environment:
      POSTGRES_DB: dokus_cashflow
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15542:5432"
    volumes:
      - postgres-cashflow-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_cashflow"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Payment Service
  postgres-payment-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-payment-local
    environment:
      POSTGRES_DB: dokus_payment
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15543:5432"
    volumes:
      - postgres-payment-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_payment"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Reporting Service
  postgres-reporting-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-reporting-local
    environment:
      POSTGRES_DB: dokus_reporting
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15544:5432"
    volumes:
      - postgres-reporting-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_reporting"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Audit Service
  postgres-audit-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-audit-local
    environment:
      POSTGRES_DB: dokus_audit
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15545:5432"
    volumes:
      - postgres-audit-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_audit"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Banking Service
  postgres-banking-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-banking-local
    environment:
      POSTGRES_DB: dokus_banking
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15546:5432"
    volumes:
      - postgres-banking-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_banking"]
      interval: 5s
      timeout: 5s
      retries: 10

  # PostgreSQL Database for Peppol Service
  postgres-peppol-local:
    image: postgres:17-alpine
    container_name: dokus-postgres-peppol-local
    environment:
      POSTGRES_DB: dokus_peppol
      POSTGRES_USER: dev
      POSTGRES_PASSWORD: localpassword
    ports:
      - "15548:5432"
    volumes:
      - postgres-peppol-local:/var/lib/postgresql/data
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dev -d dokus_peppol"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Shared Redis
  redis-local:
    image: redis:8-alpine
    container_name: dokus-redis-local
    ports:
      - "16379:6379"
    volumes:
      - redis-data-local:/data
    command: redis-server --appendonly yes --requirepass localredispass
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  # MinIO Object Storage (S3-compatible)
  minio-local:
    image: minio/minio:latest
    container_name: dokus-minio-local
    environment:
      MINIO_ROOT_USER: dokusadmin
      MINIO_ROOT_PASSWORD: dokusadminpassword
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    volumes:
      - minio-data-local:/data
    command: server /data --console-address ":9001"
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 10

  # RabbitMQ Message Broker
  rabbitmq-local:
    image: rabbitmq:3.13-management-alpine
    container_name: dokus-rabbitmq-local
    environment:
      RABBITMQ_DEFAULT_USER: dokus
      RABBITMQ_DEFAULT_PASS: localrabbitpass
      RABBITMQ_DEFAULT_VHOST: /dokus
    ports:
      - "25672:5672"    # AMQP
      - "25673:15672"  # Management UI
    volumes:
      - rabbitmq-data-local:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  # Auth Service
  auth-service-local:
    image: invoid-vision/dokus-auth:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-auth-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-auth-local:5432/dokus_auth
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      REDIS_HOST: redis-local
      REDIS_PORT: 6379
      REDIS_PASSWORD: localredispass
      RABBITMQ_HOST: rabbitmq-local
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: dokus
      RABBITMQ_PASSWORD: localrabbitpass
      RABBITMQ_VHOST: /dokus
      GEOIP_DATABASE_PATH: resources/GeoLite2-City.mmdb
      LOG_LEVEL: DEBUG
      LOG_PATH: /app/logs
    ports:
      - "7091:8080"
      - "15007:5005"
    depends_on:
      postgres-auth-local:
        condition: service_healthy
      redis-local:
        condition: service_healthy
      rabbitmq-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # Payment Service
  payment-service-local:
    image: invoid-vision/dokus-payment:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-payment-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-payment-local:5432/dokus_payment
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      LOG_LEVEL: DEBUG
    ports:
      - "7093:8080"
      - "15009:5005"
    depends_on:
      postgres-payment-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # Reporting Service
  reporting-service-local:
    image: invoid-vision/dokus-reporting:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-reporting-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-reporting-local:5432/dokus_reporting
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      LOG_LEVEL: DEBUG
    ports:
      - "7094:8080"
      - "15010:5005"
    depends_on:
      postgres-reporting-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # Audit Service (NEW)
  audit-service-local:
    image: invoid-vision/dokus-audit:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-audit-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-audit-local:5432/dokus_audit
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      RABBITMQ_HOST: rabbitmq-local
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: dokus
      RABBITMQ_PASSWORD: localrabbitpass
      RABBITMQ_VHOST: /dokus
      LOG_LEVEL: DEBUG
    ports:
      - "7095:8080"
      - "15011:5005"
    depends_on:
      postgres-audit-local:
        condition: service_healthy
      rabbitmq-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # Banking Service (NEW)
  banking-service-local:
    image: invoid-vision/dokus-banking:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-banking-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-banking-local:5432/dokus_banking
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      LOG_LEVEL: DEBUG
    ports:
      - "7096:8080"
      - "15012:5005"
    depends_on:
      postgres-banking-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # Cashflow Service (Invoice + Expense merged)
  cashflow-service-local:
    image: invoid-vision/dokus-cashflow:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-cashflow-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-cashflow-local:5432/dokus_cashflow
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      REDIS_HOST: redis-local
      REDIS_PORT: 6379
      REDIS_PASSWORD: localredispass
      RABBITMQ_HOST: rabbitmq-local
      RABBITMQ_PORT: 5672
      RABBITMQ_USERNAME: dokus
      RABBITMQ_PASSWORD: localrabbitpass
      RABBITMQ_VHOST: /dokus
      # MinIO Storage
      MINIO_ENDPOINT: http://minio-local:9000
      MINIO_ACCESS_KEY: dokusadmin
      MINIO_SECRET_KEY: dokusadminpassword
      MINIO_BUCKET: dokus-documents
      LOG_LEVEL: DEBUG
    ports:
      - "7092:8080"
      - "15008:5005"
    depends_on:
      postgres-cashflow-local:
        condition: service_healthy
      redis-local:
        condition: service_healthy
      rabbitmq-local:
        condition: service_healthy
      minio-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs
      - cashflow-storage-local:/app/storage/documents

  # Peppol Service (e-invoicing via Peppol network)
  peppol-service-local:
    image: invoid-vision/dokus-peppol:dev-${BUILD_NUMBER:-latest}
    container_name: dokus-peppol-local
    environment:
      PORT: 8080
      ENVIRONMENT: local
      DB_URL: jdbc:postgresql://postgres-peppol-local:5432/dokus_peppol
      DB_USERNAME: dev
      DB_PASSWORD: localpassword
      JWT_SECRET: local-secret-key
      JWT_ISSUER: local.dokus.tech
      JWT_AUDIENCE: dokus-api-local
      PEPPOL_ENCRYPTION_KEY: local-peppol-encryption-key-32chars!
      RECOMMAND_BASE_URL: https://api.recommand.eu
      CASHFLOW_SERVICE_BASE_URL: http://cashflow-service-local:8080
      AUTH_SERVICE_BASE_URL: http://auth-service-local:8080
      PEPPOL_INBOX_POLL_ENABLED: "true"
      PEPPOL_INBOX_POLL_INTERVAL_MINUTES: "15"
      LOG_LEVEL: DEBUG
    ports:
      - "7098:8080"
      - "15014:5005"
    depends_on:
      postgres-peppol-local:
        condition: service_healthy
      cashflow-service-local:
        condition: service_healthy
    networks:
      - dokus-local-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    volumes:
      - ./logs-local:/app/logs

  # pgAdmin for database management (profile: tools)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: dokus-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@dokus.ai
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - dokus-local-network
    profiles:
      - tools

networks:
  dokus-local-network:
    driver: bridge

volumes:
  postgres-auth-local:
  postgres-payment-local:
  postgres-reporting-local:
  postgres-audit-local:
  postgres-banking-local:
  postgres-cashflow-local:
  postgres-peppol-local:
  redis-data-local:
  rabbitmq-data-local:
  minio-data-local:
  pgadmin-data:
  cashflow-storage-local:
